---
title: "test"
author: "Calum Nicholson"
date: "17/02/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(shiny)
library(rgdal)
library(sp)
library(tidyverse)
library(leaflet)
library(leaflet.extras)
library(ggplot2)
library(sjmisc)
```

``` {r}
getwd()

```

``` {r message=FALSE, warning=FALSE, include=FALSE}
# Path to ACHD database data (note: only accessible at RPAH)
pt_data <- 'C:/Users/calum.nicholson/r-projects/achd-data/'

# Path to the study's data folder (note: only accessible at RPAH)
app_data <- '../ACHD_Dashboard/data/'

#import ACHD data
achd <- readRDS(file = paste(pt_data, 'output/rpah_analysis_dataset_2021-02-05.rds', sep=""))

#import DX coding
dx_codes <- read.csv(file = paste(app_data, '/ACHD_EPCC_coding.csv', sep=""), fileEncoding="UTF-8-BOM") %>% 
            filter(!(Variable == 'adm_AbsentPA' | Variable == 'PA' | Variable == "achd_id")) %>%
            select(!c(ACHD.Database.name, check., Variable))

#import Census data
sa2.TB <- readRDS(file = paste(app_data, 'AP_output/sa2_table_builder.rds', sep="")) %>%
                  mutate(IRSD = ordered(IRSD, c(1,2,3,4,5,6,7,8,9,10)),
                         IRSAD = ordered(IRSAD, c(1,2,3,4,5,6,7,8,9,10)))
```

> y <- achd.test %>% select(sa2, dx_codes$EPCC) %>%
+                    mutate_at(as.character(dx_codes[['EPCC']]), as.character) %>% 
+                    mutate_at(as.character(dx_codes[['EPCC']]), as.numeric) %>%
+                    group_by(sa2) %>%
+                    summarise_all(sum, na.rm = TRUE)

``` {r}
input <- 2


if (input == 2) {
            achd.df <- achd %>% dplyr::rename("area" = sa2)
            TB.df <- sa2.TB %>% dplyr::rename("area" = sa2_area)
} else if (input == 3) {
            achd.df <- achd %>% dplyr::rename("area" = sa3)
} else {
            achd.df <- achd %>% dplyr::rename("area"= sa4)}

area.achd <- achd.df %>%
              group_by(area) %>%
              dplyr::summarise(ACHD_count = n(), 
                        beth_1 = sum(bethesda_code == 1),
                        beth_2 = sum(bethesda_code == 2), 
                        beth_3 = sum(bethesda_code == 3), 
                        beth_4 = sum(bethesda_code == 4))
                
area.dx <- achd.df %>%
            mutate_at(as.character(dx_codes[['EPCC']]), as.character) %>% 
            mutate_at(as.character(dx_codes[['EPCC']]), as.numeric) %>%
            group_by(area) %>% 
            dplyr::summarise_at(as.character(dx_codes[['EPCC']]), sum, na.rm = TRUE)

area.data <- left_join(TB.df, area.achd, by = 'area') %>% 
             left_join(area.dx, by = 'area') %>%
                mutate_at(as.character(dx_codes[['EPCC']]), function(x) replace(x, is.na(x), 0)) %>%
                mutate_at(c('ACHD_count', 'beth_1', 'beth_2', 'beth_3', 'beth_4'), function(x) replace(x, is.na(x), 0))
                          
```

``` {r}
area.dx <- area.data %>% filter(SA2_5DIGIT == 11007) %>% select(dx_codes$EPCC) %>% 
            t() %>% as.data.frame() %>% 
            rename("dx_count" = V1) %>% 
            mutate(dx_label = dx_codes$Label[match(row.names(.), dx_codes$EPCC)])

ggplot(area.dx, aes(x = dx_label, y=dx_count)) + 
                    geom_bar(stat="identity") +
                    theme(axis.text.x = element_text(angle = 90)) +
                    labs(title = "Frequecy of each diagnosis", 
                         y = "count",
                         x = "") +
                    coord_flip()
```

``` {r}

test <- area.data %>% select(area, SA2_5DIGIT, IRSD, male) %>%
                      mutate(male = replace(male, male == Inf, NA))


test$cuts <- cut(as.numeric(test$IRSD), breaks = 10, label = F)
#coloured_cut <- test$cuts[test$SA2_5DIGIT == 11007]
test$color <- ifelse(test$cuts == test$cuts[test$SA2_5DIGIT == 11007][1], "Selected", "")

test %>% filter(!is.na(IRSD)) %>%
          ggplot(aes(x=IRSD, fill = cuts == test$cuts[test$SA2_5DIGIT == 11007][1])) +
                geom_bar() +
                scale_fill_manual(values = c("grey45", "red"))+
                theme_minimal() + theme(legend.position = "none")
```

``` {r}
library(scales)

rem.test <- area.data %>% select(area, SA2_5DIGIT, major_cities:very_remote) 

  datalong <- rem.test %>% filter(SA2_5DIGIT == 11007) %>%
                pivot_longer(cols = major_cities:very_remote, names_to = "remoteness")

datalong$remoteness <- factor(datalong$remoteness, levels = datalong$remoteness)

ggplot(data = datalong, aes(x = factor(remoteness), y = value)) +
  geom_col() +
  scale_y_continuous(limits = c(0,1), labels = percent) +
  theme_minimal()

```

``` {r}
achd %>% mutate(gap = as.duration(as.Date('01/10/2020', format='%d/%m/%Y') - last_clinic_2000) / dyears(1),
                ltf_3 = ifelse(gap >= 3, 1, 0),
                ltf_4 = ifelse(gap >= 4, 1, 0),
                ltf_5 = ifelse(gap >= 5, 1, 0),
                ) %>%
         select(last_clinic_2000, gap, ltf_3, ltf_4, ltf_5)

```


``` {r}
achd.1 <- achd %>% mutate(gap = as.duration(as.Date('01/10/2020', format='%d/%m/%Y') - last_clinic_2000) / dyears(1),
                          ltf_3 = ifelse(gap >= 3, 1, 0),
                          ltf_4 = ifelse(gap >= 4, 1, 0),
                          ltf_5 = ifelse(gap >= 5, 1, 0),
                          ) %>%
                   select(sa4, bethesda_code, ltf_3, ltf_4, ltf_5)


achd.1 %>% group_by(sa4) %>% dplyr::summarise(n = n(), 
                                              beth_1 = sum(bethesda_code == 1), 
                                              beth_2 = sum(bethesda_code == 2),
                                              beth_3 = sum(bethesda_code == 3),
                                              beth_4 = sum(bethesda_code == 4),
                                              ltf_3 = sum(ltf_3),
                                              ltf_4 = sum(ltf_4),
                                              ltf_5 = sum(ltf_5),
                                              )
````





```{r}
polys <- readOGR('../ACHD_Dashboard/data/shape_files/sa2_polys.shp')
```



``` {r}
polys$CODE16[polys$NAME16 == 'Riverina']

polys$NAME16[polys$CODE16 == 113]
```

``` {r}
# add the achd population for each area 
polys <- merge(polys, area.achd, by.x = 'NAME16', by.y = 'area')
#convert NAs to 0
polys@data <- polys@data %>% replace_na(list('ACHD_count' = 0))

```


``` {r}
id = as.numeric('113')


polys$CODE16[polys$NAME16 == 'Riverina']

polys$NAME16[polys$CODE16 == id]
```


%>%
            addPolygons(
                data = drive.polys(),
                layerId = ~CODE16,
                fillColor = ~pal.drive()(as.numeric(drive.polys()$shortest_time, 'hours')),
                weight = 1,
                opacity = 1,
                color = "white",
                dashArray = "3",
                fillOpacity = 0.7,
                highlight = highlightOptions(
                    weight = 3,
                    color = "#666",
                    dashArray = "",
                    fillOpacity = 0.7,
                    bringToFront = TRUE),
                label = labels.drive(),
                labelOptions = labelOptions(
                    style = list("font-weight" = "normal", padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto")) %>%
            addLegend(pal = pal.drive(), 
                      values = bins.drive(), 
                      opacity = 0.7, 
                      title = "Driving time to clinics",
                      position = "bottomright")
        


