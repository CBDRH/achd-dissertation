---
title: "ACHD_FUP"
author: "Calum Nicholson"
date: "26/06/2020"
output: html_document
---

```{r setup, include=FALSE, cache = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# set '2020_achd_map' folder as root directory
knitr::opts_knit$set(root.dir = '../..')

# Path to ACHD database data (note: only accessible at RPAH)
ACHD_path <- '/Users/calumnicholson/Documents/work/HRI/OneDrive - Heart Research Institute/To Do/'

library(dplyr)
library(tidyr)
library(purrr)
library(stringr)
library(lubridate)
library(ggplot2)
```

__Follow Up Status__

This data is at an appointment level, each record is an appointment. For this inital EDA, we are interested in converting this to a patient level dataset and pulling out some basic information about the clinic visits.
      -    How many patients are included?
      -    How many appointments does each patient have?
      -    What kinds of time range do these appointments include?


``` {r}
# load Follow Up Status dataset
FUP <- read.csv(paste(ACHD_path, 'Table_exports/FOLLOW-UP STATUS.csv', sep="")) %>%
#               ------------Clean up the data-------------------------
                # select columns for id and clinic dates
                select(fup_id, person_id, fup_last_date, fup_comment) %>%
                # rename columns
                rename( 'achd_id' = person_id,                        
                        'clinic_date' = fup_last_date, 
                        'clinic_comment' = fup_comment) %>%
                # remove timestamp from clinic date
                mutate_at("clinic_date", str_remove, pattern = " 0:00:00") %>%       
                # Convert clinic dates to Date format
                mutate_at("clinic_date",as.Date, format='%d/%m/%Y') %>%  
                # Arrange by clinic date in ascending order
                arrange(clinic_date)                                  

# create dataset of unique patient IDs for matching
achd.id <- as.data.frame(unique(FUP$achd_id)) %>%
                rename( 'achd_id' = `unique(FUP$achd_id)`)   # rename column same as above
```
The dataset contains `r length(FUP$clinic_date)` records of clinic visits with `r length(achd.id$achd_id)` patients represented.

__CLINIC VISIT__

``` {r}
CV <- read.csv(paste(ACHD_path, 'Table_exports/CLINIC VISIT.csv', sep="")) %>%
#               ------------Clean up the data-------------------------
                # select columns for id and clinic dates
                select(person_id, cv_id, cv_date, cv_hr, cv_bp_sys, cv_bp_dia, cv_o2, 
                       cv_resp, cv_height, cv_weight, cv_nyha,
                       cv_comment) %>%
                rename('achd_id' = person_id,
                       'cv_sbp' = cv_bp_sys,
                       'cv_dbp' = cv_bp_dia) %>%
                # Calculate BMI
                mutate(cv_bmi = cv_weight / ( (cv_height / 100) ^ 2) ) %>%
                # remove timestamp from clinic date
                mutate_at("cv_date", str_remove, pattern = " 0:00:00") %>%       
                # Convert clinic dates to Date format
                mutate_at("cv_date",as.Date, format='%d/%m/%Y') %>%  
                # Arrange by clinic date in ascending order
                arrange(cv_date)  
```

__Cleaning CLINICS dataset__

4 records in CLINICS have the the year as '2106' rather than '2016'. the IDs are 1174, 1168, 1091, 745

``` {r}

CV <- CV %>%
         mutate(cv_date = replace(cv_date, cv_id == 1174, as.Date('29/09/2016', format='%d/%m/%Y')),
                cv_date = replace(cv_date, cv_id == 1168, as.Date('29/09/2016', format='%d/%m/%Y')),
                cv_date = replace(cv_date, cv_id == 1091, as.Date('22/08/2016', format='%d/%m/%Y')),
                cv_date = replace(cv_date, cv_id == 745, as.Date('25/02/2016', format='%d/%m/%Y'))
                       )


```

A number of Blood Pressure records have been input back to front:
  - 1613 was input 60/135, change to 135/60
  - 1114 was input 65/120, change to 120/65
  - 1638 was input 60/118, change to 118/60
  - 1120 was input 60/110, change to 110/60
  - 1310 was input 75/110, change to 110/75
  - 1411 was input 65/110, change to 110/65
  - 4400 was input 80/100, change to 100/80
  
A number diastolic BP readings were improbable values with no clear way to fix them, so they will ne converted to NA:
  - 1654, 1015, 1506, 1949, 1082, 1186, 889, 728
  
There was a number of systolic BP readings that were improbably low, we will convert all values below 80 to NA

``` {r}
CV <- CV %>%
                #Swap BP for clinic visit ID 1613
         mutate(cv_dbp = replace(cv_dbp, cv_id == 1613, 60),
                cv_sbp = replace(cv_sbp, cv_id == 1613, 135),
                #Swap BP for clinic visit ID 1114
                cv_dbp = replace(cv_dbp, cv_id == 1114, 65),
                cv_sbp = replace(cv_sbp, cv_id == 1114, 120),
                #Swap BP for clinic visit ID 1638
                cv_dbp = replace(cv_dbp, cv_id == 1638, 60),
                cv_sbp = replace(cv_sbp, cv_id == 1638, 118),
                #Swap BP for clinic visit ID 1120
                cv_dbp = replace(cv_dbp, cv_id == 1120, 60),
                cv_sbp = replace(cv_sbp, cv_id == 1120, 110),
                #Swap BP for clinic visit ID 1310
                cv_dbp = replace(cv_dbp, cv_id == 1310, 75),
                cv_sbp = replace(cv_sbp, cv_id == 1310, 110),
                #Swap BP for clinic visit ID 1411
                cv_dbp = replace(cv_dbp, cv_id == 1411, 65),
                cv_sbp = replace(cv_sbp, cv_id == 1411, 110),
                #Swap BP for clinic visit ID 4400 
                cv_dbp = replace(cv_dbp, cv_id == 4400, 65),
                cv_sbp = replace(cv_sbp, cv_id == 4400, 110),
                # Make Diastolic BP NA
                cv_dbp = replace(cv_dbp, cv_id == 1654, NA),
                cv_dbp = replace(cv_dbp, cv_id == 1015, NA),
                cv_dbp = replace(cv_dbp, cv_id == 1506, NA),
                cv_dbp = replace(cv_dbp, cv_id == 1949, NA),
                cv_dbp = replace(cv_dbp, cv_id == 1082, NA),
                cv_dbp = replace(cv_dbp, cv_id == 1186, NA),
                cv_dbp = replace(cv_dbp, cv_id == 889, NA),
                cv_dbp = replace(cv_dbp, cv_id == 728, NA),
                # Repalce Systolic Blood pressure less than 80 with NA
                cv_sbp = replace(cv_sbp, cv_sbp < 80, NA)
                )
````


__Join follow up and clinic visit datasets__
``` {r}
clinics <- full_join(FUP, CV, by = c('achd_id', 'clinic_date' = 'cv_date'))
```


__Patient level dataset__

A nest join is be used to join the the clinic visits for each patient in the `clinic.dates` dataset to the individual patient ids in `achd.id`. 

``` {r}
# Join clinic dates with unique patient ids, creating pt level dataset with
# one column as patient id and the second column as a list of clinic dates

pt.level <- nest_join(achd.id, clinics, by = 'achd_id') 
```

The resulting dataset, `pt.level.tb`, is has two columns, the first `achd_id` contains the indiviual patients IDs and the second `clinics` is a list-column, where each record contains a dataframe of all the clinics for that patient

```{r}
# the patient level dataset
pt.level %>% head()
```

The dataframes contained in `clinics` column looks like this (for one record):

``` {r}
# display one of the clinic_dates dataframes
pt.level %>% filter(achd_id == 1101) %>% .$clinics
```

To get some more information about the clinic visits for each patient, we will pull some information out of the `clinics` column:  
        -    Number of clinics    
        -    First clinic date  
        -    Last Clinic date  
        -    Time between first and last clinic  

```{r}
# Add some more rows to the dataset
pt.level <- pt.level %>%
            mutate(
              # Number of clinics for each patient
              no_clinics = map_dbl(map(clinics, ~ .$clinic_date), length), 
              # First clinic date for each patient
              first_clinic = as_date(map_dbl(clinics, ~ min(.$clinic_date))),
              # Last clinic date for each patient
              last_clinic = as_date(map_dbl(clinics, ~ max(.$clinic_date))), 
              # Number of days between first and last clinic
              date_diff = as.duration(first_clinic %--% last_clinic) / dyears(1),
              # age at first clinic attendance
              age_first_clinic = as.period(dob %--% first_clinic),
              # age at last clinic attendance
              age_last_clinic = as.period(dob %--% last_clinic),
              # calculate average sbp
              avg_sbp = map_dbl(map(clinics, ~ .$cv_sbp), mean, na.rm = TRUE),
              # calculate average dbp
              avg_dbp = map_dbl(map(clinics, ~ .$cv_dbp), mean, na.rm = TRUE),
              # calculate average HR
              avg_hr = map_dbl(map(clinics, ~ .$cv_hr), mean, na.rm = TRUE),
              # calculate average resp rate
              avg_resp = map_dbl(map(clinics, ~ .$cv_resp), mean, na.rm = TRUE),
              # calculate average O2 rate
              avg_o2 = map_dbl(map(clinics, ~ .$cv_o2), mean, na.rm = TRUE),
              # calculate average height
              avg_height = map_dbl(map(clinics, ~ .$cv_height), mean, na.rm = TRUE),
              # calculate average weight
              avg_weight = map_dbl(map(clinics, ~ .$cv_weight), mean, na.rm = TRUE),
              # calculate average bmi
              avg_bmi = map_dbl(map(clinics, ~ .$cv_bmi), mean, na.rm = TRUE),
              )  
```

__Selecting for Clinic Visits after 2000 only__

``` {r warning = FALSE}
pt.level <- pt.level %>%
            mutate(
              # Remove visits before 01/01/2000
              clinics_2000 = map(clinics, ~ filter(., clinic_date >= as.Date('01/01/2000', format='%d/%m/%Y'))),
              # number of clinics for each patient
              no_clinics_2000 = map_dbl(map(clinics_2000, ~ .$clinic_date), length),
              # Flag to for patient with no visit before 2000
              clinic_drop = ifelse(no_clinics_2000 == 0, 1, 0),
              # First clinic date for each patient
              first_clinic_2000 = as_date(map_dbl(clinics_2000, ~ min(.$clinic_date))), 
              # Last clinic date for each patient
              last_clinic_2000 = as_date(map_dbl(clinics_2000, ~ max(.$clinic_date))),  
              # Years between first and last clinic 
              date_diff_2000 = as.duration(first_clinic_2000%--%last_clinic_2000)/dyears(1),   
              # Recode infinity to NA
              date_diff_2000 = replace(date_diff_2000, date_diff_2000 == -Inf, NA),
              # age at first clinic attendance
              age_first_clinic_2000 = as.period(dob %--% first_clinic_2000),
              # age at last clinic attendance
              age_last_clinic_2000 = as.period(dob %--% last_clinic_2000)
              # calculate average sbp
              avg_sbp_2000 = map_dbl(map(clinics_2000, ~ .$cv_sbp), mean, na.rm = TRUE),
              # calculate average dbp
              avg_dbp_2000 = map_dbl(map(clinics_2000, ~ .$cv_dbp), mean, na.rm = TRUE),
              # calculate average HR
              avg_hr_2000 = map_dbl(map(clinics_2000, ~ .$cv_hr), mean, na.rm = TRUE),
              # calculate average resp rate
              avg_resp_2000 = map_dbl(map(clinics_2000, ~ .$cv_resp), mean, na.rm = TRUE),
              # calculate average O2 rate
              avg_o2_2000 = map_dbl(map(clinics_2000, ~ .$cv_o2), mean, na.rm = TRUE),
              # calculate average height
              avg_height_2000 = map_dbl(map(clinics_2000, ~ .$cv_height), mean, na.rm = TRUE),
              # calculate average weight
              avg_weight_2000 = map_dbl(map(clinics_2000, ~ .$cv_weight), mean, na.rm = TRUE),
              # calculate average bmi
              avg_bmi_2000 = map_dbl(map(clinics_2000, ~ .$cv_bmi), mean, na.rm = TRUE),
                   )
```

There are `r length(pt.level$achd_id[pt.level$clinic_drop == 0])` patients with clinic dates after 2000.



_Number of Clinics_

The large majority of patients only have one clinic visit  
      -    Mean visits: `r mean(pt.level$no_clinics)`  
      -    Median: `r median(pt.level$no_clinics)`  
      -    Minimum: `r min(pt.level$no_clinics)`   
      -    Max: `r max(pt.level$no_clinics)`

When filter for visits after 01/01/2000 this changes to:  
      -    Mean visits: `r mean(pt.level$no_clinics_2000[pt.level$clinic_drop == 0])`  
      -    Median: `r median(pt.level$no_clinics_2000[pt.level$clinic_drop == 0])`  
      -    Minimum: `r min(pt.level$no_clinics_2000[pt.level$clinic_drop == 0])`   
      -    Max: `r max(pt.level$no_clinics_2000[pt.level$clinic_drop == 0])`  

``` {r}
ggplot(pt.level, aes(x=no_clinics)) +
      geom_histogram() +
      labs(title = "Distribution of Number of Clinic Visits",
           y = "Count", 
           x = "Number of Visits")

pt.level %>%
  filter(clinic_drop == 0) %>%
  ggplot(aes(x=no_clinics_2000)) +
        geom_histogram() +
        labs(title = "Distribution of Number of Clinic Visits after 01/01/2000", 
             y = "Count", 
             x = "Number of Visits")

```

``` {r}
pt.level %>%
  filter(no_clinics > 1) %>%
  ggplot(aes(x=no_clinics)) +
      geom_histogram() +
      labs(title = "Distribution of Number of Clinic Visits", 
           y = "Count", 
           x = "Number of Visits")

pt.level %>%
  filter(clinic_drop == 0) %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=no_clinics_2000)) +
        geom_histogram() +
        labs(title = "Distribution of Number of Clinic Visits after 01/01/2000", 
             y = "Count", 
             x = "Number of Visits")

```

_First Clinic Date_
``` {r}
ggplot(pt.level, aes(x=first_clinic)) +
      geom_histogram() +
      labs(title = "Distribution of First Clinic Visit", 
           y = "Count", 
           x = "Year")

pt.level %>%
  filter(clinic_drop == 0) %>%
  ggplot(aes(x=first_clinic_2000)) +
        geom_histogram() +
        labs(title = "Distribution of First Clinic Visit after 01/01/2000", 
             y = "Count", 
             x = "Year")
```

_Last Clinic Date_
``` {r}
ggplot(pt.level, aes(x=last_clinic)) +
      geom_histogram() +
      labs(title = "Distribution of Last Clinic Visit", 
           y = "Count", 
           x = "Year")

pt.level %>%
  filter(clinic_drop == 0) %>%
  ggplot(aes(x=last_clinic_2000)) +
        geom_histogram() +
        labs(title = "Distribution of Last Clinic Visit after 01/01/2000", 
             y = "Count", 
             x = "Year")
```

_Time between first and last clinic_

 in years
      -    Mean: `r mean(as.numeric(pt.level$date_diff))`
      -    Median: `r median(pt.level$date_diff)`
      -    Minimum: `r min(pt.level$date_diff)`
      -    Max: `r max(pt.level$date_diff)`

``` {r}
ggplot(pt.level, aes(x=date_diff)) +
      geom_histogram()+
      labs(title = "Distribution of Years between first and last visit", 
           y = "Count", 
           x = "years")

pt.level %>%
  filter(clinic_drop == 0) %>%
  ggplot(aes(x=date_diff_2000)) +
        geom_histogram()+
        labs(title = "Distribution of Years between first and last visit, after 01/01/2000", 
             y = "Count", 
             x = "years")
```

``` {r}
pt.level %>%
  filter(no_clinics > 1) %>%
  ggplot(aes(x=date_diff)) +
      geom_histogram()+
      labs(title = "Distribution of Years between first and last visit", 
           y = "Count", 
           x = "years")

pt.level %>%
  filter(clinic_drop == 0) %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=date_diff_2000)) +
        geom_histogram()+
        labs(title = "Distribution of Years between first and last visit, after 01/01/2000", 
             y = "Count", 
             x = "years")
```

``` {r}
pt.level %>%
  ggplot(aes(x=avg_sbp)) +
      geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
      scale_y_continuous(limits = c(0,0.2), labels = percent) +
      labs(title = "Distribution of Average Systolic Blood Pressure", 
           y = "Percent", 
           x = "sbp (mmHg)")

pt.level %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=avg_sbp_2000)) +
        geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
        scale_y_continuous(limits = c(0,0.2), labels = percent) +
        labs(title = "Distribution of Average Systolic Blood Pressure, after 01/01/2000", 
             y = "Percent", 
             x = "sbp (mmHg)")
```
``` {r}
pt.level %>%
  ggplot(aes(x=avg_dbp)) +
      geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
      scale_y_continuous(limits = c(0,0.2), labels = percent) +
      labs(title = "Distribution of Average Diastolic Blood Pressure", 
           y = "Percent", 
           x = "dbp (mmHg)")

pt.level %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=avg_dbp_2000)) +
        geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
        scale_y_continuous(limits = c(0,0.2), labels = percent) +
        labs(title = "Distribution of Average Diastolic Blood Pressure, after 01/01/2000", 
             y = "Percent", 
             x = "dbp (mmHg)")
```

``` {r}
pt.level %>%
  ggplot(aes(x=avg_hr)) +
      geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
      scale_y_continuous(limits = c(0,0.2), labels = percent) +
      labs(title = "Distribution of Average heart rate", 
           y = "Percent", 
           x = "Heartrate (bmp)")

pt.level %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=avg_hr_2000)) +
        geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
        scale_y_continuous(limits = c(0,0.2), labels = percent) +
        labs(title = "Distribution of Average heart rate, after 01/01/2000", 
             y = "Percent", 
             x = "Heartrate (bmp)")
```


``` {r}
pt.level %>%
  ggplot(aes(x=avg_resp)) +
      geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
      scale_y_continuous(limits = c(0,0.2), labels = percent) +
      labs(title = "Distribution of Average Respiratory Rate", 
           y = "Percent", 
           x = "Respiratory Rate")

pt.level %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=avg_resp_2000)) +
        geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
        scale_y_continuous(limits = c(0,0.2), labels = percent) +
        labs(title = "Distribution of Average Respiratory Rate, after 01/01/2000", 
             y = "Percent", 
             x = "Respiratory Rate")
```

``` {r}
pt.level %>%
  ggplot(aes(x=avg_o2)) +
      geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
      scale_y_continuous(limits = c(0,0.25), labels = percent) +
      labs(title = "Distribution of Average Oxygen Saturation", 
           y = "Percent", 
           x = "Oxygen Saturation (%)")

pt.level %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=avg_o2_2000)) +
        geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
        scale_y_continuous(limits = c(0,0.25), labels = percent) +
        labs(title = "Distribution of Average Oxygen Saturation, after 01/01/2000", 
             y = "Percent", 
             x = "Oxygen Saturation (%)")
```

``` {r}
pt.level %>%
  ggplot(aes(x=avg_height)) +
      geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
      scale_y_continuous(limits = c(0,0.15), labels = percent) +
      labs(title = "Distribution of Average Height", 
           y = "Percent", 
           x = "Height (cms)")

pt.level %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=avg_height_2000)) +
        geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
        scale_y_continuous(limits = c(0,0.15), labels = percent) +
        labs(title = "Distribution of Average Height, after 01/01/2000", 
             y = "Percent", 
             x = "Height (cms)")
```

``` {r}
pt.level %>%
  ggplot(aes(x=avg_weight)) +
      geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
      scale_y_continuous(limits = c(0,0.1), labels = percent) +
      labs(title = "Distribution of Average Weight", 
           y = "Percent", 
           x = "Weight (kgs)")

pt.level %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=avg_weight_2000)) +
        geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
        scale_y_continuous(limits = c(0,0.1), labels = percent) +
        labs(title = "Distribution of Average Weight, after 01/01/2000", 
             y = "Percent", 
             x = "Weight (kgs)")
```



``` {r}
pt.level %>%
  ggplot(aes(x=avg_bmi)) +
      geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
      scale_y_continuous(limits = c(0,0.2), labels = percent) +
      labs(title = "Distribution of Average BMI", 
           y = "Percent", 
           x = "bmi")

pt.level %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=avg_bmi_2000)) +
        geom_histogram(aes( y = ..count../sum(..count..) ), bins = 50)+
        scale_y_continuous(limits = c(0,0.2), labels = percent) +
        labs(title = "Distribution of Average BMI, after 01/01/2000", 
             y = "Percent", 
             x = "bmi")
```