---
title: "ACHD_ADMIN"
author: "Calum Nicholson"
date: "18/06/2020"
output: html_document
---

__To do__
Select data for patients with correct address recorded  
Check through values for clinic_comment, what do they all mean how can we organise them? 
Check how removing missing data affects the demographics.



```{r setup, include=FALSE, cache = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# set '2020_achd_map' folder as root directory
knitr::opts_knit$set(root.dir = '../..')

# Path to ACHD database data (note: only accessible at RPAH)
ACHD_path <- 'Y:/CURRENT_STUDIES/2020_achd_map/'

library(tidyverse)
library(lubridate)
library(ggplot2)
library(scales)
```

__Create a 'Person-Level' Dataset__

The ACHD database contains a number of tables, joined by the person identified "person_id". These will be joined into a single person level datasat. The key tables are:
    -    ADMIN: names, addresses, contact details, dob, sex.  
    -    MAIN: contains the minimum dataset, with diagnosis information and who their clincian is (i,e. DC, RC or SHC).  
    -    DEMOGRAPHICS: This contains basic demographics information. A lot of this table in incomplete, however there is useful information in country of birth and indigenous status.  
    -    FOLLOW UP STATUS: This is a 'clinic level' dataset, where each record is a clinic visit, with the date of the visit and a comment about which clinic is was (i.e. which private doctor, or public clinic or outreach clinic)     
    -    CLINIC VISIT: Similar to the follow up table but contained more detailed info (i.e bp and heart rate). has only been collecting info for the past two years and only for DCs patients  
    -    DEATH: Recording deceased patients, taken from NDI data linkage.


_ADMIN_
``` {r}
# Load ADMIN table from ACHD database
ADMIN <- read.csv(paste(ACHD_path, 'Table_exports/ADMIN.csv', sep="")) %>%
#         ------------Clean up the data-------------------------  
          # select columns
          dplyr::select(person_id, adm_sex, adm_date_of_birth,                                   
                 adm_suburb_locality, adm_postcode, adm_state_abbreviation) %>%
          # rename columns
          rename('achd_id' = person_id,                                                   
                 'sex' = adm_sex,
                 'dob' = adm_date_of_birth,
                 'suburb' = adm_suburb_locality,
                 'postcode' = adm_postcode,
                 'state' = adm_state_abbreviation) %>%
          # remove timestamp from visit date
          mutate_at("dob", str_remove, pattern = " 0:00:00") %>%
          # Convert clinic dates to Date format
          mutate_at("dob", as.Date, format='%d/%m/%Y') %>% 
          # Calculate age on 01 Jan 2020
          mutate(age = as.period(dob %--% as.Date("01/01/2020", format='%d/%m/%Y'))) %>%
          # Flag for ages greater than 18 years old
          mutate(age_flag = ifelse(as.numeric(age, "years") >= 18, 1, 0)) %>%
          # Remove whitespace from suburb name
          mutate_at("suburb", str_trim, side = "both") %>% 
          # Change all suburbs to uppercase
          mutate_at("suburb", str_to_upper, locale = "en") %>% 
          # Convert suburb from to character format
          mutate_at("suburb", as.character) %>%     
          # Convert postcode to character format
          mutate_at("postcode", as.character)                                              
```

_MAIN_
``` {r}
# Load the MAIN table from the ACHD database
MAIN <- read.csv(paste(ACHD_path, 'Table_exports/MAIN.csv', sep=""))  %>%
#       ------------Clean up the data-------------------------  
        select(person_id, Other:PAS, SupraAS:ABNPV, ABNTV:TAPVD,                          
               achd.1, SHC, DC, adm_RC) %>% 
        rename('achd_id' = person_id,
               'dx_comment' = achd.1,
               'RC' = adm_RC)                                                     

```

All of the diagnosis variables code 1 or -1 for true and 0 or NA for untrue. To make it a little easier to read, we will recode -1 to 1 and NA to 0.

``` {r}
# all the diagnosis variables
dx_names <- c('Other', 'AbnRV', 'DIRV', 'SubPS', 'PAS', 'SupraAS',
              'SupraPS', 'ABNPV', 'ABNTV', 'ABNAO', 'PAPVD', 'DEXTROCARDIA', 'LVNONCOMPACT', 'PFO', 'PDA',
              'AbnAV', 'TRUNCART', 'AVSD', 'VSD', 'ASD', 'UnkDx', 'ccTGA', 'MAPCA.s', 'DORV', 'TA', 'DILV',
              'PS', 'PA', 'EISENMENGER.S', 'FONTAN', 'TGA', 'TOF', 'HLHS', 'AbnMV', 'SupraMS', 'AoInterrupt',
              'SubAS', 'AoC', 'Ebstein.s', 'BAVD', 'TAPVD')

# convert NA values to 0
MAIN <- MAIN %>% mutate_at(dx_names,
                            function(x) replace(x, (is.na(x)), 0) # recode all na values to 0
                           ) %>%
                 mutate_at(dx_names,
                            function(x) replace(x, (x == -1), 1) # recode all -1 values to 1
                           ) %>%
                mutate(no_dx = rowSums(.[,dx_names]))
```




_DEMOGRAPHICS_
``` {r}
# load the DEMOGRAPHICS table from the ACHD database
DEMOG <- read.csv(paste(ACHD_path, 'Table_exports/DEMOGRAPHICS.csv', sep="")) %>%
#       ------------Clean up the data-------------------------  
         select(person_id, dem_country, dem_indigenous_status) %>%
         rename("achd_id" = person_id,
                "cob" = dem_country,
                "ats" = dem_indigenous_status)
  
  
```

the ATS has some miss coding, it has a few different ways of coding missing vales( "", "99", "Un"), and two ways of coding one ("1", "01").

``` {r}
# convert to character vector
DEMOG$ats <- as.character(DEMOG$ats)

# Check the unique values in ATS
unique(DEMOG$ats)

# Recode
DEMOG$ats[DEMOG$ats == "" | DEMOG$ats == "99" | DEMOG$ats == "Un"] <- NA
DEMOG$ats[DEMOG$ats == "01"] <- "1"

# Check again
unique(DEMOG$ats)
```



_DEATH_
``` {r}
# load the DEATH table from the ACHD database
DEATH <- read.csv(paste(ACHD_path, 'Table_exports/DEATH.csv', sep="")) %>%
#        ------------Clean up the data-------------------------  
         # remove unnecessary columns
         select(person_id, death_date) %>%                             
         # remove timestamp from death date
         mutate_at("death_date", str_remove, pattern = " 0:00:00") %>%        
         # convert death date to date type
         mutate_at("death_date", as.Date, format='%d/%m/%Y') %>%              
         # add flag for death
         mutate(death = 1) %>%                                                
         # rename columns
         rename("achd_id" = person_id)                                        
```

_SA2 AREAS_
``` {r}
# Import SA2 Lookup table
sa2_lookup <- read.csv("./achd-dissertation/EDA/output/sa2_lookup.csv") %>%
#             ------------Clean up the data-----------------  
              # select subrub, postcode and sa2 name columns
              select(LOCALITY_NAME,POSTCODE,SA2_NAME) %>% 
              # Convert postcode to character
              mutate_at("POSTCODE", as.character) %>%    
              # Convert suburb name to character
              mutate_at("LOCALITY_NAME", as.character)    

# Import ASGS Lookup table
asgs_lookup <- read.csv("./achd-dissertation/EDA/output/ASGS_lookup.csv") %>%
#             ------------Clean up the data-----------------  
              # select subrub, postcode and sa2 name columns
              select(LOCALITY_NAME,POSTCODE,SA2_NAME, SA3_NAME_2016, SA4_NAME_2016) %>% 
              # Convert postcode to character
              mutate_at("POSTCODE", as.character) %>%    
              # Convert suburb name to character
              mutate_at("LOCALITY_NAME", as.character)    
```

``` {r}
# Add the ASGS area names to the ADMIN dataset, based on the suburb and postcode name
ADMIN_sa2 <- left_join(ADMIN, asgs_lookup, by = c("suburb" = "LOCALITY_NAME", 
                                                 "postcode" = "POSTCODE"))
```

_Cardiac ARIA_

TBA

_FOLLOW UP STATUS_
``` {r}
# load Follow Up Status dataset
FUP <- read.csv(paste(ACHD_path, 'Table_exports/FOLLOW-UP STATUS.csv', sep="")) %>%
#               ------------Clean up the data-------------------------
                # select columns for id and clinic dates
                select(person_id, fup_last_date, fup_comment) %>%
                # rename columns
                rename( 'achd_id' = person_id,                        
                        'clinic_date' = fup_last_date, 
                        'clinic_comment' = fup_comment) %>%
                # remove timestamp from clinic date
                mutate_at("clinic_date", str_remove, pattern = " 0:00:00") %>%       
                # Convert clinic dates to Date format
                mutate_at("clinic_date",as.Date, format='%d/%m/%Y') %>%  
                # Arrange by clinic date in ascending order
                arrange(clinic_date)   
```

_Clinic Comments_

``` {r}
clinic.comment <- as.data.frame(table(FUP$clinic_comment)) %>%
              #rename columns
              rename("clinic_comment" = Var1,
                     "count" = Freq) %>%
              #arrange by Frequency
              arrange(desc(count))
```

These are comments on each clinic visit, generally telling us which clinic was attended at this date, DC and RC are the two main CHD cardiologists, SHC is the public CHD clinic 'sydney heart centre'. These comments are free text and inconsistent but will be important when determining clinic visits. There are `r length(clinic.comment$clinic_comment)` types of comments here.

```{r}
#Top 15 clinic comments
knitr::kable(clinic.comment[1:15,])
```

``` {r}
# Join the tables to create a person level dataset

                # Add data from Demographics Table
person.level <- left_join(ADMIN_sa2, DEMOG, by = "achd_id") %>%
                rename("sa2" = SA2_NAME) %>%
                # Add data from MAIN table
                left_join(MAIN, by = "achd_id") %>%
                # Add data from DEATH table
                left_join(DEATH, by = 'achd_id') %>%
                # Add 0 flag for people still alive in 'death' variable
                mutate(death = replace(death, is.na(death), 0)) %>%
                # add age at death   
                mutate(age_death = as.period(dob %--% death_date)) %>% 
                # add data from Follow Up Status table
                nest_join(FUP, by = 'achd_id') %>%
                rename( 'clinics' =  y)
```

The dataframes contained in `clinics` column looks like this (for one record):

``` {r}
# display one of the clinic_dates dataframes
person.level %>% filter(achd_id == 1101) %>% .$clinics
```

To get some more information about the clinic visits for each patient, we will pull some information out of the `clinics` column
        -    Number of clinics
        -    First clinic date
        -    Last Clinic date
        -    Time between first and last clinic
        -    Age at first and last clinic

```{r, warning = FALSE}
# Add some more rows to the dataset
person.level <- person.level %>%
#             --------------ADD NEW COLUMNS ABOUT CLINIC DATES________________________
              mutate(
              # Number of clinics for each patient
              no_clinics = map_dbl(map(clinics, ~ .$clinic_date), length), 
              # First clinic date for each patient
              first_clinic = as_date(map_dbl(clinics, ~ min(.$clinic_date))),
              # Last clinic date for each patient
              last_clinic = as_date(map_dbl(clinics, ~ max(.$clinic_date))), 
              # Number of days between first and last clinic
              date_diff = as.duration(first_clinic %--% last_clinic) / dyears(1),
              # age at first clinic attendance
              age_first_clinic = as.period(dob %--% first_clinic),
              # age at last clinic attendance
              age_last_clinic = as.period(dob %--% last_clinic),
              # Remove visits before 01/01/2000
              clinics_2000 = map(clinics, ~ filter(., clinic_date >= as.Date('01/01/2000', format='%d/%m/%Y'))),
              # number of clinics for each patient
              no_clinics_2000 = map_dbl(map(clinics_2000, ~ .$clinic_date), length),
              # Flag for patient with no visit before 2000
              clinic_drop = ifelse(no_clinics_2000 == 0, 1, 0),
              # First clinic date for each patient
              first_clinic_2000 = as_date(map_dbl(clinics_2000, ~ min(.$clinic_date))), 
              # Last clinic date for each patient
              last_clinic_2000 = as_date(map_dbl(clinics_2000, ~ max(.$clinic_date))),  
              # Years between first and last clinic 
              date_diff_2000 = as.duration(first_clinic_2000%--%last_clinic_2000)/dyears(1),   
              # Recode infinity to NA
              date_diff_2000 = replace(date_diff_2000, date_diff_2000 == -Inf, NA),
              # age at first clinic attendance
              age_first_clinic_2000 = as.period(dob %--% first_clinic_2000),
              # age at last clinic attendance
              age_last_clinic_2000 = as.period(dob %--% last_clinic_2000)
              ) 
```

__Selecting for records with valid addresses__

Check the dataset for missing postcodes, states, overseas or interstate addresses. a few of the records have some missing data but we can safely infer what the missing information is and fix them up:  
      -    achd_id 910 has subrub of CLAREVILLE, but is missing the postcode, CLAREVILLE only matches to one SA2 area in the lookup table so we can safely assume the postcode is the same as the lookup table: 2107  
      -    achd_ids 4732, 4883, 4892 the state field missing, but the postcode and suburb are in NSW, so we can add the state as NSW  


``` {r}
person.level <- person.level %>%
                mutate(
                  postcode = replace(postcode, achd_id == 910, 2107),
                  suburb = replace(suburb, achd_id == 4732, "NSW"),
                  suburb = replace(suburb, achd_id == 4883, "NSW"),
                  suburb = replace(suburb, achd_id == 4892, "NSW")
                       ) %>%
                mutate(
                  valid_address = ifelse( ( suburb != "" & suburb != "OVERSEAS" & suburb != "-") &
                                            postcode != "" &
                                            ( state == "NSW" | state == "ACT"), 1, 0)
                       )
```

There are still some typos in the address fields from the dataset, resulting in 228 records that need to be checked by hand.

``` {r}
person.level %>% filter(valid_address == 1) %>%
                 filter(is.na(sa2)) %>%
                 select(achd_id,postcode, suburb, state, sa2)
```



__Note: Testing the SA2 Area Join__

``` {r}
location <- person.level %>%
              select(achd_id,suburb,postcode) %>%
              mutate_at("suburb", as.character) %>%  
              mutate_at("postcode", as.character)

# create test set from locations data
test <- location[c(1:8,10,12),]

# add SA2 areas matched by hand
test$by_hand <- c('Crows Nest - Watson',
                  'Bolton Point - Teralba',
                  'Picton - Tahmoon - Buxton',
                  'Warriewood - Mona Vale',
                  'Frenchs Forest - Belrose',
                  'Blaxlan - Warrimoo - Lapstone',
                  'Orange',
                  'Glenmore Park - Regentville',
                  'Leichhardt - Annandale',
                  'Manly - Fairlight')

knitr::kable(test)

```

``` {r}
#join tables by postcode and suburb
test_join <- left_join(test, sa2_lookup, by = c("suburb" = "LOCALITY_NAME", "postcode" = "POSTCODE")) %>%
                    rename("Match by Code" = SA2_NAME,
                           "Match by Hand" = by_hand)

```

```{r}
knitr::kable(test_join)

```
__Cleaning Data Types__
``` {r, echo = FALSE}
# Variables to convert to factor
names_factor <- c('achd_id' ,'sex', 'age_flag', 'cob', 'ats', 'Other', 'AbnRV', 'DIRV', 'SubPS', 'PAS', 'SupraAS',
                  'SupraPS', 'ABNPV', 'ABNTV', 'ABNAO', 'PAPVD', 'DEXTROCARDIA', 'LVNONCOMPACT', 'PFO', 'PDA',
                  'AbnAV', 'TRUNCART', 'AVSD', 'VSD', 'ASD', 'UnkDx', 'ccTGA', 'MAPCA.s', 'DORV', 'TA', 'DILV',
                  'PS', 'PA', 'EISENMENGER.S', 'FONTAN', 'TGA', 'TOF', 'HLHS', 'AbnMV', 'SupraMS', 'AoInterrupt',
                  'SubAS', 'AoC', 'Ebstein.s', 'BAVD', 'TAPVD', 'RC', 'death', 'clinic_drop', 'valid_address')

# Convert the above variables to factors
person.level[,names_factor] <- lapply(person.level[,names_factor] , factor)

# convert teh diagnosis comment to a character vector
person.level$dx_comment <- as.character(person.level$dx_comment)
```


``` {r}
print('Variables and data types')
sapply(person.level, class)
```


__EDA__  
The data cleaning above has created three variables that we will use to filter out invalid records  
    - age_flag: flags people 18 and over (1) or below 18 (0)  
    - valid_address: flags people with valid addresses (1) or invalid (0)  
    - clinic_drop: flags records with no clinic visits after 01/01/2000 (1) or those with clinics after that date (0)  

The purpose of this EDA is to explore how filtering out records based on the criteria above affects important data



_Distribution of patient above and below 18 years old_
``` {r, echo = FALSE, warning = FALSE}
knitr::kable(person.level %>% count(age_flag)) 
```

_Distribution of patient with and without clinic dates after 01/01/2000_
``` {r, echo = FALSE, warning = FALSE}
knitr::kable(person.level %>% count(clinic_drop))
```

_Distribution of patients with and without valid addresses_
``` {r, echo = FALSE, warning = FALSE}
knitr::kable(person.level %>% count(valid_address))
```

Create a second dataset that filters out the above  
    - Patients 18 or over (`age_flag == 1`)  
    - Patients with a valid address (`valid_address == 1`)  
    - Patients with clinic visits after 01/01/2020 (`clinic_drop == 0`)
    
``` {r}
person.level.filtered <- person.level %>%
                            filter(age_flag == 1 &
                                   valid_address == 1 &
                                   clinic_drop == 0)

```


``` {r, echo = FALSE}
print("Dimensions of the original dataset")
paste('Number of variables:', dim(person.level)[2])
paste('Number of records:', dim(person.level)[1])

print("Dimensions of the filtered dataset")
paste('Number of variables:', dim(person.level.filtered)[2])
paste('Number of records:', dim(person.level.filtered)[1])
```




``` {r}
# check missingness in the original dataset
sapply(person.level, function(x) sum(is.na(x)))

```
``` {r}
# check missingness in the filtered dataset
sapply(person.level.filtered, function(x) sum(is.na(x)))

```

_Number of Clinics_

``` {r, echo = FALSE}
ggplot(person.level, aes(x=no_clinics)) +
      geom_bar(aes( y = ..count../sum(..count..))) +
      scale_y_continuous(limits = c(0,0.7), labels = percent) +
      scale_x_continuous(breaks = seq(0,20,1)) +
      labs(title = "Distribution of Number of Clinic Visits", 
           y = "Percent", 
           x = "Number of Visits")


ggplot(person.level.filtered, aes(x=no_clinics_2000)) +
      geom_bar(aes( y = ..count../sum(..count..))) +
      scale_y_continuous(limits = c(0,0.7), labels = percent) +
      scale_x_continuous(breaks = seq(0,20,1)) +
      labs(title = "Distribution of Number of Clinic Visits after 01/01/2000", 
           y = "Percent", 
           x = "Number of Visits")

```

``` {r, echo = FALSE}
person.level %>%
  filter(no_clinics > 1) %>%
  ggplot(aes(x=no_clinics)) +
      geom_bar(aes( y = ..count../sum(..count..))) +
      scale_y_continuous(limits = c(0,0.5), labels = percent) +
      scale_x_continuous(breaks = seq(0,20,1)) +
      labs(title = "Distribution of Number of Clinic Visits", 
           y = "Percent", 
           x = "Number of Visits")

person.level.filtered %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=no_clinics_2000)) +
        geom_bar(aes( y = ..count../sum(..count..))) +
        scale_y_continuous(limits = c(0,0.5), labels = percent) +
        scale_x_continuous(breaks = seq(0,20,1)) +
        labs(title = "Distribution of Number of Clinic Visits after 01/01/2000", 
             y = "Percent", 
             x = "Number of Visits")

```

_First Clinic Date_
``` {r, echo = FALSE}
ggplot(person.level, aes(x=first_clinic)) +
      geom_histogram(aes( y = ..count../sum(..count..))) +
      scale_y_continuous(limits = c(0,0.25), labels = percent) +
      labs(title = "Distribution of First Clinic Visit", 
           y = "Percent", 
           x = "Year")

ggplot(person.level.filtered, aes(x=first_clinic_2000)) +
      geom_histogram(aes( y = ..count../sum(..count..))) +
      scale_y_continuous(limits = c(0,0.25), labels = percent) +
      labs(title = "Distribution of First Clinic Visit after 01/01/2000", 
           y = "Percent", 
           x = "Year")
```

_Last Clinic Date_
``` {r, echo = FALSE}
ggplot(person.level, aes(x=last_clinic)) +
      geom_histogram(aes( y = ..count../sum(..count..))) +
      scale_y_continuous(limits = c(0,0.25), labels = percent) +
      labs(title = "Distribution of Last Clinic Visit", 
           y = "Percent", 
           x = "Year")

ggplot(person.level.filtered, aes(x=last_clinic_2000)) +
      geom_histogram(aes( y = ..count../sum(..count..))) +
      scale_y_continuous(limits = c(0,0.25), labels = percent) +
      labs(title = "Distribution of Last Clinic Visit after 01/01/2000", 
           y = "Percent", 
           x = "Year")
```

_Time between first and last clinic_

 in years
      -    Mean: `r mean(as.numeric(person.level$date_diff))`
      -    Median: `r median(person.level$date_diff)`
      -    Minimum: `r min(person.level$date_diff)`
      -    Max: `r max(person.level$date_diff)`

``` {r, echo = FALSE}
ggplot(person.level, aes(x=date_diff)) +
      geom_histogram(aes( y = ..count../sum(..count..))) +
      scale_y_continuous(limits = c(0,0.7), labels = percent) +
      labs(title = "Distribution of Years between first and last visit", 
           y = "Percent", 
           x = "years")

ggplot(person.level.filtered, aes(x=date_diff_2000)) +
      geom_histogram(aes( y = ..count../sum(..count..))) +
      scale_y_continuous(limits = c(0,0.7), labels = percent) +
      labs(title = "Distribution of Years between first and last visit, after 01/01/2000", 
           y = "Percent", 
           x = "years")
```

``` {r, echo = FALSE}
person.level %>%
  filter(no_clinics > 1) %>%
  ggplot(aes(x=date_diff)) +
      geom_histogram(aes( y = ..count../sum(..count..)))+
      scale_y_continuous(limits = c(0,0.3), labels = percent) +
      labs(title = "Distribution of Years between first and last visit", 
           y = "Percent", 
           x = "years")

person.level.filtered %>%
  filter(no_clinics_2000 > 1) %>%
  ggplot(aes(x=date_diff_2000)) +
        geom_histogram(aes( y = ..count../sum(..count..)))+
        scale_y_continuous(limits = c(0,0.3), labels = percent) +
        labs(title = "Distribution of Years between first and last visit, after 01/01/2000", 
             y = "Percent", 
             x = "years")
```

_sex_
``` {r, echo = FALSE}
ggplot(person.level, aes(x=as.factor(sex))) +
  geom_bar(aes( y = ..count../sum(..count..)))+
  scale_y_continuous(limits = c(0,0.6), breaks = seq(0,0.6,0.1), labels = percent) +
  labs(title = "Sex", 
       y = "Percent", 
       x = "Sex")


ggplot(person.level.filtered, aes(x=as.factor(sex))) +
  geom_bar(aes( y = ..count../sum(..count..)))+
  scale_y_continuous(limits = c(0,0.6), breaks = seq(0,0.6,0.1), labels = percent) +
  labs(title = "Sex", 
       y = "Percent", 
       x = "Sex")
```



_age_

```{r, echo = FALSE}
person.level %>%
  filter(death == 0) %>%
  ggplot(aes(x=as.numeric(age, "years"))) +
    geom_histogram(aes( y = ..count../sum(..count..)), bins = 50)+
    scale_y_continuous(limits = c(0,0.1), labels = percent) +
    scale_x_continuous(limits = c(0,120)) +
    labs(title = "Age", 
         y = "count", 
         x = "years")

person.level.filtered %>%
  filter(death == 0) %>%
  ggplot(aes(x=as.numeric(age, "years"))) +
    geom_histogram(aes( y = ..count../sum(..count..)), bins = 50)+
    scale_y_continuous(limits = c(0,0.1), labels = percent) +
    scale_x_continuous(limits = c(0,120)) +
    labs(title = "Age", 
         y = "count", 
         x = "years")


```

_cob_

```{r, echo = FALSE}
ggplot(person.level, aes(x=as.factor(cob))) +
  geom_bar(aes( y = ..count../sum(..count..)))+
  scale_y_continuous(limits = c(0,0.7), breaks = seq(0,0.7,0.1), labels = percent) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "COB", 
       y = "count", 
       x = "cob")

ggplot(person.level.filtered, aes(x=as.factor(cob))) +
  geom_bar(aes( y = ..count../sum(..count..)))+
  scale_y_continuous(limits = c(0,0.7), breaks = seq(0,0.7,0.1), labels = percent) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "COB", 
       y = "count", 
       x = "cob")


```

_ats_

```{r, echo = FALSE}
ggplot(person.level, aes(x=as.factor(ats))) +
  geom_bar(aes( y = ..count../sum(..count..)))+
  scale_y_continuous(limits = c(0,0.7), breaks = seq(0,0.7,0.1), labels = percent) +
  labs(title = "ats", 
       y = "count", 
       x = "ats")

ggplot(person.level.filtered, aes(x=as.factor(ats))) +
  geom_bar(aes( y = ..count../sum(..count..)))+
  scale_y_continuous(limits = c(0,0.7), breaks = seq(0,0.7,0.1), labels = percent) +
  labs(title = "ats", 
       y = "count", 
       x = "ats")
```
 _death_

```{r, echo = FALSE}
ggplot(person.level, aes(x=as.factor(death))) +
  geom_bar(aes( y = ..count../sum(..count..)))+
  scale_y_continuous(limits = c(0,1), labels = percent) +
  labs(title = "death", 
       y = "Percent", 
       x = "death")

ggplot(person.level.filtered, aes(x=as.factor(death))) +
  geom_bar(aes( y = ..count../sum(..count..)))+
  scale_y_continuous(limits = c(0,1), labels = percent) +
  labs(title = "death", 
       y = "Percent", 
       x = "death")
```

_age at death_

```{r, echo = FALSE}
ggplot(person.level, aes(x=as.numeric(age_death, "years"))) +
  geom_histogram(aes( y = ..count../sum(..count..)), bins = 50)+
  scale_y_continuous(limits = c(0,0.1), labels = percent) +
  labs(title = "age at death", 
       y = "count", 
       x = "age at death")

ggplot(person.level.filtered, aes(x=as.numeric(age_death, "years"))) +
  geom_histogram(aes( y = ..count../sum(..count..)), bins = 50)+
  scale_y_continuous(limits = c(0,0.1), labels = percent) +
  labs(title = "age at death", 
       y = "count", 
       x = "age at death")
```


_Diagnoses_

``` {r echo = FALSE}
ggplot(person.level, aes(x=no_dx)) +
  geom_bar(aes( y = ..count../sum(..count..)))+
  scale_y_continuous(limits = c(0,1), labels = percent) +
  scale_x_continuous(breaks = seq(0,10,1)) +
  labs(title = "Number of Diangoses per person", 
       y = "count", 
       x = "Number of Diagnoses")

ggplot(person.level.filtered, aes(x=no_dx)) +
  geom_bar(aes( y = ..count../sum(..count..)))+
  scale_y_continuous(limits = c(0,1), labels = percent) +
  scale_x_continuous(breaks = seq(0,10,1)) +
  labs(title = "Number of Diangoses per person", 
       y = "count", 
       x = "Number of Diagnoses")
```

``` {r echo = FALSE}
print('number of people with no diagnosis - original dataset:')
length(person.level$achd_id[person.level$no_dx == 0])

print('number of people with no diagnosis - original dataset:')
length(person.level.filtered$achd_id[person.level.filtered$no_dx == 0])
```


``` {r, echo = FALSE}
dx.only <- person.level %>%
  select(dx_names) %>%
  mutate_all(as.character) %>%
  mutate_all(as.numeric)

dx.only.filtered <- person.level.filtered %>%
  select(dx_names) %>%
  mutate_all(as.character) %>%
  mutate_all(as.numeric)
```

``` {r, echo = FALSE}
dx.count <- dx.only %>%
            summarise_all(sum, na.rm = TRUE) %>%
            t() 

dx.count <- as.data.frame(dx.count)
dx.count$HeaderName <- row.names(dx.count)

ggplot(dx.count, aes(x = HeaderName, y=V1)) + 
  geom_bar(stat="identity",) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Frequecy of each diagnosis - full dataset", 
     y = "count",
     x = "")
```


``` {r, echo = FALSE}
dx.count.filtered <- dx.only.filtered %>%
            summarise_all(sum, na.rm = TRUE) %>%
            t() 

dx.count.filtered <- as.data.frame(dx.count.filtered)
dx.count.filtered$HeaderName <- row.names(dx.count.filtered)

ggplot(dx.count.filtered, aes(x = HeaderName, y=V1)) + 
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Frequecy of each diagnosis - filtered dataset", 
     y = "count",
     x = "")
```

_Counting the ACHD population in each area_

``` {r}
# count the number achd patients in each SA2 area
sa2.count <- person.level.filtered %>% count(sa2) %>%
                        rename("ACHD_count" = n)

# count the number achd patients in each SA3 area
sa3.count <- person.level.filtered %>% count(SA3_NAME_2016) %>%
                        rename("ACHD_count" = n)

# count the number achd patients in each SA4 area
sa4.count <- person.level.filtered %>% count(SA4_NAME_2016) %>%
                        rename("ACHD_count" = n)

# join the SA2 ACHD count with the area level dataset
area.df <- readRDS(file = "./achd-dissertation/EDA/output/sa2_table_builder.rds")
area.df.2 = left_join(area.df, sa2.count, by = c("sa2_area" = "sa2"))

# Save the SA2 area level data with the ACHD count included
#saveRDS(area.df.2, file = paste(ACHD_path, 'output/sa2_data.rds', sep=""))
#write.csv(area.df.2, paste(ACHD_path, 'output/sa2_data.csv', sep=""))

# Save the SA2 area level data with the ACHD count included
#saveRDS(sa2.count, file = paste(ACHD_path, 'output/sa2.count.rds', sep=""))
#write.csv(sa2.count, paste(ACHD_path, 'output/sa2.count.csv', sep=""))

# Save the SA3 ACHD count
#saveRDS(sa3.count, file = paste(ACHD_path, 'output/sa3.count.rds', sep=""))
#write.csv(sa3.count, paste(ACHD_path, 'output/sa3.count.csv', sep=""))

# Save the SA4 ACHD count
#saveRDS(sa4.count, file = paste(ACHD_path, 'output/sa4.count.rds', sep=""))
#write.csv(sa4.count, paste(ACHD_path, 'output/sa4.count.csv', sep=""))

```












