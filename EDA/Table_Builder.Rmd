---
title: "Table Builder EDA"
author: "Calum Nicholson"
date: "08/06/2020"
output: html_document
---

```{r setup, include=FALSE, cache = FALSE}
knitr::opts_chunk$set(echo = TRUE)
# set 'data' folder as root directory
knitr::opts_knit$set(root.dir = '../..')

library(dplyr)
```

## Function For importing Table Builder data 

Table Builder data was downloaded on 5 Jun 2020. The data is located in Dissertation/data/Table_builder_SA2_NSW.

Each table row in this folder is an SA2 area for NSW, with the columns describing a certain demographic. This function will import the data and remove the unneccesary rows.

``` {r}
# Function to import and clean SA2 Tables
read.SA2.table <-function (filename, path = "./Table_builder_SA2_NSW/") {
  
#    '''
#    Takes an table downloaded from Table Builder at the SA2 levels, containing all NSW SA2 #areas, and converts it to a dataframe
#    
#    INPUT
#    filename:       string, name of the file with extension
#    path:           string, path to the file
#    
#    OUTPUT
#    sa2.df:         dataframe, Table builder data with excess removed
#    ```
  
    #load table
    age <- readLines(paste(path,filename, sep=''))
    
    #tidy the data
    age <- age[-(1:9)] #remove header
    age <- age[-2] #remove SA2 label
    age <- age[-(581:588)] #remove footer
    
    #load data into dataframe
    sa2.df <- read.table(text = age, sep =",", header = TRUE, stringsAsFactors = FALSE)
    sa2.df
}

# age
head(read.SA2.table('age_10P.csv'))

```

## Creating Area level variables

Going though each of the tables, adding variables into a final dataset, sa2.data.

__total population, sex and country of birth__

``` {r}

# load some tables
sex <- read.SA2.table('sex.csv')
COB <- read.SA2.table('COB.csv')

# SA2 area names
sa2_area <- sex$SEXP.Sex

# Total population in each area
total_pop <- sex$Total

# Percentages in each area
male <- ( sex$Male / total_pop ) * 100
female <- ( sex$Female / total_pop ) * 100
overseas <- ( COB$COB_overseas / total_pop ) * 100

# combine variables
sa2.data <- data.frame(sa2_area, total_pop, male, female, overseas)
head(sa2.data)

```
__childcare__

``` {r}
# load data
childcare_cat <- read.SA2.table('child_care.csv')

# percentage of population engaged in childcare
childcare <-  childcare_cat %>%
                mutate(sum = rowSums(.[3:5])) %>%
                mutate(perc = sum / Total * 100) %>%
                select(CHCAREP.Unpaid.Child.Care, perc)

# update column names
names(childcare) <- c('sa2_area','childcare')

# add to data set
sa2.data <- merge(sa2.data, childcare, by = 'sa2_area')

``` 
__employment__

``` {r}
# load data
employ_cat <- read.SA2.table('employment_status.csv')

# percentage of unemployed in each area
employ <- employ_cat %>%
              mutate(sum = rowSums(.[5:6])) %>%
              mutate(perc = sum / Total * 100) %>%
              select(LFSP.Labour.Force.Status, perc)

# update column names
names(employ) <- c('sa2_area','employ')

# add to data set
sa2.data <- merge(sa2.data, employ, by = 'sa2_area')

``` 
__overcrowding__
``` {r}
# load data
overcrowding_cat <- read.SA2.table('overcrowding.csv')

# Overcrowding measured by number of spare rooms, or number of rooms needed in household
# Percentage who have spare rooms (positive), and percentage who need more rooms (negative)
overcrowding <- overcrowding_cat %>%
              mutate(positive = rowSums(.[7:10])) %>%
              mutate(negative = rowSums(.[2:5])) %>%
              mutate(perc_pos = positive / Total * 100) %>%
              mutate(perc_neg = negative / Total * 100) %>%
              select(HOSD.Housing.Suitability, perc_pos, perc_neg)

# update column names
names(overcrowding) <- c('sa2_area','oc_positive', 'oc_negative')

# add to data set
sa2.data <- merge(sa2.data, overcrowding, by = 'sa2_area')

```
__single parents__
``` {r}
# load data
single_parent_cat <- read.SA2.table('single_parent.csv')

#Percentage of single parent households; male, female and total
single_parent <- single_parent_cat %>%
              mutate(sp_male = Male.lone.parent / Total * 100) %>%
              mutate(sp_female = Female.lone.parent / Total * 100) %>%
              mutate(sp_total = sp_male + sp_female) %>%  
              select(SLPP.Sex.of.Lone.Parent, sp_male, sp_female, sp_total)

# update column names
names(single_parent) <- c('sa2_area','sp_male','sp_female','sp_total')

# add to data set
sa2.data <- merge(sa2.data, single_parent, by = 'sa2_area')
```

__students__
``` {r}
# load data
student_cat <- read.SA2.table('student_status.csv')

# percentage of students in each area
student <- student_cat %>%
              mutate(student_sum = rowSums(.[3:4])) %>%
              mutate(student_perc = student_sum / Total * 100) %>% 
              select(STUP.Full.Time.Part.Time.Student.Status, student_perc)

# update column names
names(student) <- c('sa2_area','student')

# add to data set
sa2.data <- merge(sa2.data, student, by = 'sa2_area')


```

__age__
``` {r}
# load data
#add age groups for each area
age_cat <- read.SA2.table('age_10P.csv')

# age categories, in 10 year age groups.
age_cat <- select(age_cat, AGE10P...Age.in.Ten.Year.Groups:X100.years.and.over)

# update column names
names(age_cat) <- c('sa2_area','age0','age10',
                    'age20','age30','age40',
                    'age50','age60','age70',
                    'age80','age90','age100')

# add to data set
sa2.data <- merge(sa2.data, age_cat, by = 'sa2_area')

```

``` {r}
# Final table
knitr::kable(head(sa2.data))

#write.csv(sa2.data, "./achd-dissertation/EDA/output/sa2_table_builder.csv")

```








