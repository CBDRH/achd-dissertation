---
title: "ACHD_ADMIN"
author: "Calum Nicholson"
date: "18/06/2020"
output: html_document
---

```{r setup, include=FALSE, cache = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# set '2020_achd_map' folder as root directory
knitr::opts_knit$set(root.dir = '../..')

# Path to ACHD database data (note: only accessible at RPAH)
ACHD_path <- 'Z:/CURRENT_STUDIES/2020_achd_map'

library(dplyr)
library(stringr)
library(lubridate)
```


``` {r}
# Load ADMIN table from ACHD database
ADMIN <- read.csv(paste(ACHD_path, 'Table_exports/ADMIN.csv', sep="")) %>%
#         ------------Clean up the data-------------------------  
          select(person_id, adm_sex, adm_date_of_birth,                                   # select columns
                 adm_suburb_locality, adm_postcode, adm_state_abbreviation) %>%
  
          rename('achd_id' = person_id,                                                   # rename columns
                 'sex' = adm_sex,
                 'dob' = adm_date_of_birth,
                 'suburb' = adm_suburb_locality,
                 'postcode' = adm_postcode,
                 'state' = adm_state_abbreviation) %>%
  
          mutate_at("dob", str_remove, pattern = " 0:00:00") %>%                           # remove timestamp from visit date
          mutate_at("dob", as.Date, format='%d/%m/%Y') %>%                                 # Convert clinic dates to Date format
          mutate(age = as.period(dob %--% as.Date("01/01/2020", format='%d/%m/%Y'))) %>%   # Calculate age on 01 Jan 2020
          mutate_at("suburb", str_trim, side = "both") %>%                                 # Remove whitespace from subrub name
          mutate_at("suburb", str_to_upper, locale = "en") %>%                             # Change all suburbs to uppercase
          mutate_at("suburb", as.character) %>%                                            # Convert suburb from to character format
          mutate_at("postcode", as.character)                                              # Convert postcode to character format
```


``` {r}
# Load the MAIN table from the ACHD database

MAIN <- read.csv(paste(ACHD_path, 'Table_exports/MAIN.csv', sep=""))  %>%
#       ------------Clean up the data-------------------------  
        select(person_id, Other:PAS, SupraAS:ABNPV, ABNTV:TAPVD,                          # select columns
               achd.1, SHC, DC, adm_RC) %>%                                             
        rename('achd_id' = person_id)                                                     # rename columns

```


``` {r}
# load the DEMOGRAPHICS table from the ACHD database
DEMOG <- read.csv(paste(ACHD_path, 'Table_exports/DEMOGRAPHICS.csv', sep="")) %>%
#       ------------Clean up the data-------------------------  
         select(person_id, dem_country, dem_indigenous_status) %>%
         rename("achd_id" = person_id)
  
  
```


``` {r}
# Import SA2 Lookup table
sa2_lookup <- read.csv("./achd-dissertation/EDA/output/sa2_lookup.csv") %>%
#             ------------Clean up the data-----------------  
              select(LOCALITY_NAME,POSTCODE,SA2_NAME) %>%                  # select subrub, postcode and sa2 name columns
              mutate_at("POSTCODE", as.character) %>%                      # Convert postcode to character
              mutate_at("LOCALITY_NAME", as.character)                     # Convert suburb name to character
```

``` {r}
# Add the SA2 area names to the ADMIN dataset, based on the suburb and postcode name
ADMIN_sa2 <- left_join(ADMIN, sa2_lookup, by = c("suburb" = "LOCALITY_NAME", 
                                                 "postcode" = "POSTCODE"))
```

``` {r}
# load Follow Up Status dataset
FUP <- read.csv(paste(ACHD_path, 'Table_exports/FOLLOW-UP STATUS.csv', sep="")) %>%
#               ------------Clean up the data-------------------------
                select(person_id, fup_last_date, fup_comment) %>%          # select columns for id and clinic dates
                rename( 'achd_id' = person_id,                             # rename columns
                        'clinic_date' = fup_last_date, 
                        'clinic_comment' = fup_comment) %>%       
                mutate_at("clinic_date",                              
                          str_remove, pattern = " 0:00:00") %>%            # remove timestamp from clinic date
                mutate_at("clinic_date",                              
                          as.Date, format='%d/%m/%Y') %>%                  # Convert clinic dates to Date format
                arrange(clinic_date)                                       # Arrange by clinic date in ascending order

```


``` {r}
# Join the table to create a person level dataset
person_level <- left_join(ADMIN_sa2, DEMOG, by = "achd_id") %>%
                left_join(MAIN, by = "achd_id")

# deidentified version
person_level_deid <- select(person_level, -dob, -suburb, -postcode, -state)



```

``` {r}

# Count of ACHD patients in each SA2 area
sa2_freq <- as.data.frame(table(person_level$SA2_NAME))
# Rename columns
names(sa2_freq) <- c('SA2_NAME', 'ACHD_Count')
#Check spread
hist(sa2_freq$ACHD_Count, breaks=50)

```

__To do__
Add the follow up clinic dates and comments to the table via a nest join  
Select data for patients with correct address recorded  
Select data from clinic dates (i.e. as in ACHD_FUP.rmd file)  

Check how removing missing data affects the demographics.  





``` {r}
# create test set from locations data
test <- location[1:10,]

# add SA2 areas matched by hand
test$by_hand <- c('Crows Nest - Watson',
                  'Bolton Point - Teralba',
                  'Picton - Tahmoon - Buxton',
                  'Warriewood - Mona Vale',
                  'Frenchs Forest - Belrose',
                  'Blaxlan - Warrimoo - Lapstone',
                  'Orange',
                  'Glenmore Park - Regentville',
                  'Leichhardt - Annandale',
                  'Manly - Fairlight')

knitr::kable(test)

```

``` {r}
# select nessecary columns from both datasets
test <- test %>%
          dplyr::select(achd_id,suburb,postcode,by_hand)



# Convert postcodes and subrubs to character
test$postcode <- as.character(test$postcode)
sa2_lookup$POSTCODE <- as.character(sa2_lookup$POSTCODE)

test$suburb <- as.character(test$suburb)
sa2_lookup$LOCALITY_NAME <- as.character(sa2_lookup$LOCALITY_NAME)

#join tables by postcode and suburb
test_join <- left_join(test, sa2_lookup, by = c("suburb" = "LOCALITY_NAME", "postcode" = "POSTCODE")) %>%
                    rename("Match by Code" = SA2_NAME,
                           "Match by Hand" = by_hand)

```

```{r}
knitr::kable(test_join)

```

``` {r}
# Convert postcodes and subrubs to character
location$postcode <- as.character(location$postcode)
location$suburb <- as.character(location$suburb)

# Join the SA2 lookup table to the entire location dataset by suburb and postcode
location_sa2 <- left_join(location, sa2_lookup, by = c("suburb" = "LOCALITY_NAME", 
                                                       "postcode" = "POSTCODE"))

# Records that did not match to an SA2 area
location_missing <- location_sa2 %>% filter(is.na(SA2_NAME))
length(location_missing$state)

```

There are a number of records that did not match. A quick look by had shows a number of typos and/or incorrect postcodes. This may need to be fixed by hand.


``` {r}
# Count of ACHD patients in each SA2 area
sa2_freq <- as.data.frame(table(location_sa2$SA2_NAME))
# Rename columns
names(sa2_freq) <- c('SA2_NAME', 'ACHD_Count')
#Check spread
hist(sa2_freq$ACHD_Count, breaks=50)

```

``` {r}

# Import SA2 Lookup table
sa2_Table_Builder <- read.csv("./achd-dissertation/EDA/output/sa2_table_builder.csv")

```

``` {r}

# Join ACHD freqs number with area level predictors for some correlations
area.data <- left_join(sa2_Table_Builder, sa2_freq, by = c('sa2_area' = 'SA2_NAME'))

```










