---
title: "ACHD Report"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(scales)
library(lubridate)
library(ggplot2)
library(ggpubr)
library(rgdal)
library(sp)
library(sf)
library(leaflet)
library(leaflet.extras)
library(tableHTML)
library(knitr)
library(kableExtra)
```

```{css, echo = FALSE}
.main-container {
    max-width: 90%;
}
```

``` {r, include = FALSE, echo = FALSE}
# the filtered achd data
achd <- achd.filtered()

# area level achd data (note, before are changes are made by new clinic additions)
area.achd <- drive.area.achd()

# Diagnosis Frequency Data
dx.data <- dx.count()
```


This report was generated on `r Sys.Date()` from the Adult Congenital Heart Disease Clinic Planning Tool

## Patient Data

``` {r, include = FALSE, echo = FALSE}
# Some named list that can be used to pull the labels for each of the filters used on the patient data

# Sex filter
sex <- list('1' = 'Male',
            '2' = 'Female',
            '4' = 'Neither')

# bethesda severity filter
beth <- list('1' ="Simple",
             '2' ="Moderate",
             '3' ="Severe",
             '4' = "Unknown")

# Mortality Status filter
mort <- list('0' = 'Alive',
             '1' = 'Deceased')
```

The Patient Dataset had the following filters applied:  
  
* __Selected Genders:__ `r sex[input$sb.sex]`  
* __CHD Disease Severity:__ `r  beth[input$sb.bethesda]`
* __Age Range:__ `r input$sb.age[1]` yrs to `r input$sb.age[2]` yrs  
* __Time Period:__ `r format(as.Date(input$sb.dates[1]), "%d/%m/%Y")` to `r format(as.Date(input$sb.dates[2]), "%d/%m/%Y")`  
* __Years Since Last Clinic Visit:__ `r input$sb.last.clinic[1]` yrs to `r input$sb.last.clinic[2]` yrs  
* __Mortality Status:__ `r  mort[input$sb.mortality]` 

After Filtering, these are some basic demographics of the patient data:  

``` {r, include = FALSE, echo = FALSE }
pt.summary <- data.frame(no.patient = achd %>% summarise(
                                                    achd.no = n(),
                                                    simple.no = sum(bethesda_code == 1),
                                                    moderate.no = sum(bethesda_code == 2),
                                                    complex.no = sum(bethesda_code == 3)
                                                  ) %>% t(),
                         ltf.patient = achd %>% filter(ltf_3 == 1) %>%
                                                summarise(
                                                    achd.no = n(),
                                                    simple.no = sum(bethesda_code == 1),
                                                    moderate.no = sum(bethesda_code == 2),
                                                    complex.no = sum(bethesda_code == 3)
                                                  )  %>% t(),
                         hr.patient = area.achd %>% filter(as.numeric(shortest_time, "hours") <= 1) %>%
                                                    summarise(
                                                      hr.no = sum(ACHD_count),
                                                      hr.simple = sum(beth_1),
                                                      hr.moderate = sum(beth_2),
                                                      hr.complex = sum(beth_3)
                                                    ) %>% t()
                          ) %>% 
                            mutate(ltf.percent = percent( ltf.patient / no.patient ),
                                   hr.percent = percent( hr.patient / no.patient )) %>%
                            select(no.patient, ltf.percent, hr.percent)

row.names(pt.summary) <- c("All", "Simple CHD", "Moderate CHD", "Complex CHD")
```

``` {r, echo = FALSE}
pt.summary %>%
  kbl(align=rep('c', 3),
      col.names = c("No. Patients",
                  "Lost to F/up",
                  "Pts < 1 hr drive"),
      caption = "<b>Table 1</b>: Number of patients, lost to follow up rates and driving time to clinics;
                                 by disease severity") %>%
  kable_classic_2(full_width = F, position = "left",
                  html_font = "Cambria",
                  font_size = 16)
```

``` {r, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
age_plot <- ggplot(achd, aes(x=as.numeric(age, "years"))) +
                  geom_histogram(fill = "light grey", color = "black") +
                  labs(y = "Number of Patients", 
                       x = "Age (yrs)") +
                  theme(axis.title.x=element_blank()) +
                  theme_minimal()

sex_plot <- achd %>% filter(!is.na(sex)) %>%
                ggplot(aes(x=sex)) +
                    geom_bar(fill = "light grey", color = "black") +
                    scale_x_discrete(name = "",
                                     labels=c("1" = "Male", "2" = "Female",
                                              "4" =  "Neither Female or Male")) +
                    labs(y = "Number of Patients") +
                    theme(axis.title.x=element_blank()) +
                    theme_minimal()

ndx_plot <- ggplot(achd, aes(x=as.integer(no_dx)) ) +
                    geom_bar(fill = "light grey", color = "black") +
                    scale_x_continuous() +
                    labs(x = "Number of Diagnoses", 
                         y = "Number of Patients") +
                    theme() +
                    theme_minimal() 

nclinic_plot <- ggplot(achd, aes(x=no_clinics_2000)) +
                        geom_bar(fill = "light grey", color = "black") +
                        scale_x_continuous() +
                        labs(x = "Number of Clinic Visits", 
                             y = "Number of Patients") +
                        theme() +
                        theme_minimal() 

ltf_plot <- ggplot(achd, aes(x=as.numeric(gap_2000, "years"))) +
                        geom_histogram(fill = "light grey", color = "black") +
                        labs(y = "Number of Patients", 
                             x = "Time since last clinic visit (yrs)") +
                        theme(axis.title.x=element_blank()) +
                        theme_minimal()

dx_plot <- dx.data %>% filter(dx_count > 0) %>% 
                          ggplot(aes(x = reorder(dx_label, dx_count), y=dx_count)) + 
                              geom_bar(stat="identity", fill = "light grey", color = "black", size = 0.25) +
                              theme(axis.text.x = element_text(angle = 90)) +
                              labs(title = "Frequecy of each diagnosis", 
                                   y = "count",
                                   x = "") +
                              coord_flip() +
                              theme_minimal()
```
  
&nbsp;  

``` {r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=20}
ggarrange(
  ggarrange(age_plot, ltf_plot, labels = c("A","B"), nrow = 1),
  ggarrange(sex_plot, ndx_plot, nclinic_plot, labels = c("C", "D", "E"), nrow = 1),
  ggarrange(dx_plot, labels = ("F"), nrow = 1), 
  nrow = 3, heights = c(1,1,6)
  )
```

## Area Data

``` {r, echo = FALSE, include = FALSE}
area.summary <- data.frame(
  no.areas = area.achd %>% summarise(
                      no.areas = n(),
                      no.areas.syd = sum(GCC_NAME == "Greater Sydney", na.rm = TRUE),
                      no.areas.nsw = sum(GCC_NAME == "Rest of NSW", na.rm = TRUE),
                      no.areas.act = sum(GCC_NAME == "Australian Capital Territory", na.rm = TRUE),
                           ) %>% t(),
  n.area.hr = area.achd %>% filter(as.numeric(shortest_time, "hours") <= 1) %>%
                        summarise(
                        no.areas = n(),
                        no.areas.syd = sum(GCC_NAME == "Greater Sydney", na.rm = TRUE),
                        no.areas.nsw = sum(GCC_NAME == "Rest of NSW", na.rm = TRUE),
                        no.areas.act = sum(GCC_NAME == "Australian Capital Territory", na.rm = TRUE),
                            ) %>% t(),
  avg.drive = avg.drive <- area.achd %>% 
                    summarise(avg.drive = mean(as.numeric(shortest_time, 'hours'), na.rm = TRUE),
                              avg.drive.syd = mean(as.numeric(shortest_time[.$GCC_NAME == "Greater Sydney"], 'hours'), 
                                                   na.rm = TRUE),
                              avg.drive.nsw = mean(as.numeric(shortest_time[.$GCC_NAME == "Rest of NSW"], 'hours'), 
                                                   na.rm = TRUE),
                              avg.drive.act = mean(as.numeric(shortest_time[.$GCC_NAME == "Australian Capital Territory"],
                                                              'hours'), 
                                                   na.rm = TRUE),
                              ) %>% t()
                ) %>%
                mutate(p.area.hr = percent(n.area.hr / no.areas) ) %>%
                select(no.areas, n.area.hr, p.area.hr, avg.drive)

row.names(area.summary) <- c("All", "Greater Sydney", "Rest of NSW", "ACT")
```

Areas are the Statistical Area 2 (SA2) geographical boundaries, defined by the Australian Bureau of Statistics, below is a basic summary of the area level data before any new ACHD clinic locations have been selected:

``` {r, echo = FALSE}
library(knitr)
library(kableExtra)

area.summary %>%
  kbl(align=rep('c', 4),
      col.names = c("No. Areas",
                  "Areas < 1hr",
                  "Areas < 1hr (%)",
                  "Avg Drive Time (hr)"),
      caption = "<b>Table 2</b>: Number of areas within one hour drive
                 to an ACHD clinic and the average driving time to ACHD clinics") %>%
  kable_classic_2(full_width = F, position = "left",
                  html_font = "Cambria",
                  font_size = 16)

```

&nbsp;  
&nbsp; 

``` {r, echo = FALSE, include = FALSE}
area_st_plot <- function() {
          all <- ggplot(area.achd, aes(x=as.numeric(shortest_time, "min"))) +
                            geom_histogram(fill = "light grey", bins = 50,
                                           color = "black", size = 0.25) +
                            theme_minimal() +
                            theme(axis.title.x=element_blank(),
                                  axis.title.y=element_blank()
                                  ) +
                            scale_x_continuous(limits = c(0,600)) +
                              ggtitle("All")
          
          syd <- area.achd %>% filter(GCC_NAME == "Greater Sydney") %>%
                            ggplot(aes(x=as.numeric(shortest_time, "min"))) +
                              geom_histogram(fill = "light grey", bins = 50,
                                             color = "black", size = 0.25) +
                              theme_minimal() +
                              theme(axis.title.x=element_blank(),
                                    axis.title.y=element_blank()
                                    ) +
                              scale_x_continuous(limits = c(0,100)) +
                              ggtitle("Sydney")
          
          nsw <- area.achd %>% filter(GCC_NAME == "Rest of NSW") %>%
                            ggplot(aes(x=as.numeric(shortest_time, "min"))) +
                              geom_histogram(fill = "light grey", bins = 50,
                                             color = "black", size = 0.25) +
                              theme_minimal() +
                              theme(axis.title.x=element_blank(),
                                    axis.title.y=element_blank()
                                    ) +
                              scale_x_continuous(limits = c(0,600)) +
                              ggtitle("Rest of NSW") 
          
          act <- area.achd %>% filter(GCC_NAME == "Australian Capital Territory") %>%
                            ggplot(aes(x=as.numeric(shortest_time, "min"))) +
                              geom_histogram(fill = "light grey", bins = 50,
                                             color = "black", size = 0.25) +
                              theme_minimal() +
                              theme(axis.title.x=element_blank(),
                                    axis.title.y=element_blank()
                                    ) +
                              scale_x_continuous(limits = c(0,100)) +
                              ggtitle("ACT")
          
          layout <- ggarrange(all, syd, nsw, act, nrow = 2, ncol = 2)
          
          annotate_figure(layout,
                          bottom = text_grob("Driving Time (mins)",
                                               size = 10),
                          left = text_grob("No.SA2 Areas", rot = 90,
                                             size = 10)
                          )

}
```

&nbsp;  
&nbsp;  

``` {r, echo = FALSE, warning = FALSE, message = FALSE}
area_st_plot()
```
&nbsp;  
__Figure 2:__ Distribution of the driving time from each SA2 area to the nearest ACHD clinic, for all of NSW, the Greater Sydney Region, the Rest of NSW and the Australia Capital Territory

### Distribution of the ACHD population
The map below shows the number of ACHD patients in each area. Driving times are calculated from the centre of each area.

&nbsp; 

``` {r, echo = FALSE, include = FALSE}
#Filter the current map data by gcc region selected
current_map_data <- area.achd %>% filter(GCC_NAME %in% input$drive.gcc)

# Set colour palette for driving map
current_pal_drive <- colorNumeric("YlOrRd", domain = as.numeric(current_map_data$shortest_time, 'hours'))

# Set colour palette for locations map
current_pal_loc <- colorNumeric("YlOrRd", domain = current_map_data$ACHD_count)

current_labels <- sprintf(
            "<strong>%s</strong><br/>
            %i ACHD patients<br/>
            Simple: %i | Moderate: %i | Severe: %i<br/>
            %.1f hr drive to nearest clinic<br/>",
            current_map_data$sa2_area, 
            current_map_data$ACHD_count,
            current_map_data$beth_1, current_map_data$beth_2, current_map_data$beth_3,
            as.numeric(current_map_data$shortest_time, 'hours')
            ) %>% 
                lapply(htmltools::HTML)
```

``` {r, echo = FALSE, fig.width=13, fig.height=10}
leaflet() %>%
            addTiles() %>%
            # Add Polygons
            addPolygons(
                    data = drive.polys(),
                    layerId = ~CODE16,
                    fillColor = ~current_pal_loc(current_map_data$ACHD_count),
                    weight = 1,
                    opacity = 1,
                    color = "white",
                    dashArray = "3",
                    fillOpacity = 0.7,
                    highlight = highlightOptions(
                        weight = 3,
                        color = "#666",
                        dashArray = "",
                        fillOpacity = 0.7,
                        bringToFront = TRUE),
                    label = current_labels,
                    labelOptions = labelOptions(
                        style = list("font-weight" = "normal", padding = "3px 8px"),
                        textsize = "15px",
                        direction = "auto")) %>%
                fitBounds(min(set_coords()$long),
                          min(set_coords()$lat),
                          max(set_coords()$long),
                          max(set_coords()$lat)) %>%
              # Add Legend
              addLegend(pal = current_pal_loc, 
                          values = current_map_data$ACHD_count, 
                          opacity = 0.7, 
                          title = "ACHD population",
                          position = "bottomright")

```


## Current ACHD Clinics in NSW

There are currently 6 Clinic locatios for Adult Congenital Heart Disease Services in NSW. Please note that not all clinic locations are available in the Hospital Travel Times dataset, in these cases, the closest available hospital has been used instead. The table below outlines the clinic matches and the distance between them.

``` {r, echo = FALSE, include = FALSE}
clinic.matches <- data.frame(
  achd.clinic = c("Orange Central West Cardiology",
               "Nowra Shoalhaven Cardiology",
               "Canberra More Than Medicine",
               "Port Macquarie Port Macquarie Cardiology",
               "Royal Prince Alfred Hospital",
               "Westmead Private Hospital"
              ),
  htt.clinic = c("Orange Day Surgery Centre",
                 "Shoalhaven Hospital",
                 "Canberra Imaging Group Angiography/Interventional Suite",
                 "Port Macquarie Hospital",
                 "Royal Prince Alfred Hospital",
                 "Westmead Private Hospital"
                ),
  distance = c("1.1kms", "1.2kms", "8 kms", "0.5 kms", "0 kms", "0 kms")
)
```


``` {r, echo = FALSE}
clinic.matches %>%
  kbl(align=rep('c', 3),
      col.names = c("Current ACHD Clinics",
                  "Closest HTT Clinics",
                  "Distance between"),
      caption = "<b>Table 3</b>: Matching current ACHD clinics to Hospital 
                 Travel Time (HTT) Clincis") %>%
  kable_classic_2(full_width = F, position = "left",
                  html_font = "Cambria",
                  font_size = 16)


```

&nbsp;  

``` {r, echo = FALSE}
drive.values$current_clinic_table %>%
  bind_rows(summarise_all(., ~if(is.numeric(.)) sum(.) else "Total")) %>%
            kbl(align=rep('c', 3),
      col.names = c("Current ACHD Clinics",
                  "Patient within 1hr",
                  "Lost to F/up within 1hr"),
      caption = "<b>Table 4</b>: Number of patients captured by each hospital") %>%
  kable_classic_2(full_width = F, position = "left",
                  html_font = "Cambria",
                  font_size = 16) 
```

&nbsp;  

### Average Driving time to ACHD Clinics  
The map below details the driving time from each SA2 area in NSW to the nearest ACHD Clinic. Driving times are calculated from the centre of each area.

&nbsp;  

``` {r, echo = FALSE, fig.width=13, fig.height=10}
leg_data <- current_map_data %>% filter(!is.na(shortest_time))

leaflet() %>%
            addTiles() %>%
            addAwesomeMarkers(
                data = htt.details %>% filter(Hospital_ID %in% achd_ids),
                lng = ~Longitude,
                lat = ~Latitude,
                label = ~Hospital.name,
                icon = ~HospitalIcons["Current"]) %>%
            # Add Polygons
            addPolygons(
                data = drive.polys(),
                layerId = ~CODE16,
                fillColor = ~current_pal_drive(as.numeric(current_map_data$shortest_time, 'hours')),
                weight = 1,
                opacity = 1,
                color = "white",
                dashArray = "3",
                fillOpacity = 0.7,
                highlight = highlightOptions(
                    weight = 3,
                    color = "#666",
                    dashArray = "",
                    fillOpacity = 0.7,
                    bringToFront = TRUE),
                label = current_labels,
                labelOptions = labelOptions(
                    style = list("font-weight" = "normal", padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto")) %>%
                fitBounds(min(set_coords()$long),
                          min(set_coords()$lat),
                          max(set_coords()$long),
                          max(set_coords()$lat)) %>%
                # Add Legend
                addLegend(pal = current_pal_drive, 
                          values = as.numeric(leg_data$shortest_time, 'hours'), 
                          opacity = 0.7, 
                          title = "Driving time (hrs)",
                          position = "bottomright",
                          layerId = 'drive.legend')

```

&nbsp;  

## New ACHD Clinics in NSW

The following clinics were selected as potentials for new locations in NSW

``` {r, echo = FALSE}

drive.values$add_clinic_table %>%
  select(-ID) %>%
  bind_rows(summarise_all(., ~if(is.numeric(.)) sum(.) else "Total")) %>%
            kbl(align=rep('c', 3),
      col.names = c("New ACHD Clinics",
                  "Patient within 1hr",
                  "Lost to F/up within 1hr"),
      caption = "<b>Table 5</b>: Number of patients captured in the new clinics") %>%
  kable_classic_2(full_width = F, position = "left",
                  html_font = "Cambria",
                  font_size = 16)

```

### Average Driving time to ACHD Clinics  
The map below details the driving time from each SA2 area in NSW to the nearest ACHD Clinic. Driving times are calculated from the centre of each area.

&nbsp;  

``` {r, echo = FALSE, fig.width=13, fig.height=10}
leg_data_new <- drive.polys()@data %>% filter(!is.na(shortest_time))

leaflet() %>%
            addTiles() %>%
            setView(147.016667, -32.163333, zoom = 5.5) %>%
            addAwesomeMarkers(
                data = htt.details %>% filter(Hospital_ID %in% achd_ids),
                lng = ~Longitude,
                lat = ~Latitude,
                label = ~Hospital.name,
                icon = ~HospitalIcons["Current"]) %>%
            # Add Polygons
            addPolygons(
                data = drive.polys(),
                layerId = ~CODE16,
                fillColor = ~current_pal_drive(as.numeric(drive.polys()$shortest_time, 'hours')),
                weight = 1,
                opacity = 1,
                color = "white",
                dashArray = "3",
                fillOpacity = 0.7,
                highlight = highlightOptions(
                    weight = 3,
                    color = "#666",
                    dashArray = "",
                    fillOpacity = 0.7,
                    bringToFront = TRUE),
                label = labels.drive(),
                labelOptions = labelOptions(
                    style = list("font-weight" = "normal", padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto")) %>%
                fitBounds(min(set_coords()$long),
                          min(set_coords()$lat),
                          max(set_coords()$long),
                          max(set_coords()$lat)) %>%
                # Add Legend
                addLegend(pal = current_pal_drive, 
                          values = as.numeric(leg_data$shortest_time, 'hours'), 
                          opacity = 0.7, 
                          title = "Driving time (hrs)",
                          position = "bottomright",
                          layerId = 'drive.legend')%>%
                # Add markers for new clinics
                addAwesomeMarkers(
                    data = htt.details %>% filter(Hospital_ID %in% drive.values$add_clinic_table$ID),
                    lng = ~Longitude,
                    lat = ~Latitude,
                    label = ~Hospital.name,
                    group = "new_markers",
                    icon = ~HospitalIcons["New"])

```

&nbsp;  
&nbsp; 

``` {r, echo = FALSE, include = FALSE}
clinic.compare.current <- data.frame(
                        no_pt = area.achd %>% filter(as.numeric(shortest_time, "hours") <= 1) %>%
                                                                          summarise(no_pt = sum(ACHD_count)),
                        ltf_no = area.achd %>% filter(as.numeric(shortest_time, "hours") <= 1) %>%
                                                                          summarise(ltf_no = sum(ltf_3)),
                        avg_drive = area.achd %>% summarise(avg_drive = mean(as.numeric(shortest_time, 'hours'), 
                                                                             na.rm = TRUE)),
                        long_drive = area.achd %>% summarise(long_drive = max(as.numeric(shortest_time, 'hours'), 
                                                                             na.rm = TRUE))
                      ) %>% mutate(
                        hr_p = no_pt / sum(area.achd$ACHD_count),
                        ltf_p = ltf_no / sum(area.achd$ltf_3)
                      ) %>%
                      select(no_pt, hr_p, ltf_no, ltf_p, avg_drive, long_drive)
                                                      
clinic.compare.new <- data.frame(
                        no_pt = drive.polys()@data %>% filter(as.numeric(shortest_time, "hours") <= 1) %>%
                                                                          summarise(no_pt = sum(ACHD_count)),
                        ltf_no = drive.polys()@data %>% filter(as.numeric(shortest_time, "hours") <= 1) %>%
                                                                          summarise(ltf_no = sum(ltf_3)),
                        avg_drive = drive.polys()@data %>% summarise(avg_drive = mean(as.numeric(shortest_time, 'hours'), 
                                                                             na.rm = TRUE)),
                        long_drive = drive.polys()@data %>% summarise(long_drive = max(as.numeric(shortest_time, 'hours'), 
                                                                             na.rm = TRUE))
                      ) %>% mutate(
                        hr_p = no_pt / sum(drive.polys()@data$ACHD_count),
                        ltf_p = ltf_no / sum(drive.polys()@data$ltf_3)
                      ) %>%
                      select(no_pt, hr_p, ltf_no, ltf_p, avg_drive, long_drive)

diff <- data.frame(
  no_pt = clinic.compare.new$no_pt - clinic.compare.current$no_pt,
  hr_p = clinic.compare.new$hr_p - clinic.compare.current$hr_p,
  ltf_no = clinic.compare.new$ltf_no - clinic.compare.current$ltf_no,
  ltf_p = clinic.compare.new$ltf_p - clinic.compare.current$ltf_p,
  avg_drive = clinic.compare.new$avg_drive - clinic.compare.current$avg_drive,
  long_drive = clinic.compare.new$long_drive - clinic.compare.current$long_drive
)

clinic.compare <- rbind(clinic.compare.current, clinic.compare.new, diff) %>%
                          mutate(hr_p = percent(hr_p),
                                 ltf_p = percent(ltf_p)
                                 )

row.names(clinic.compare) <- c("Current Clincs Locations", "New Clinics Locations", "Difference")

```


``` {r, echo = FALSE}
clinic.compare %>%
            kbl(align=rep('c', 6),
      col.names = c("No. Patient within 1hr",
                    "Perc. Patients within 1hr",
                    "No. Lost to F/up within 1hr",
                    "Perc. Lost to F/up within 1hr",
                    "Average Driving to ACHD Clinic",
                    "Longest Driving time to ACHD Clinic"),
      caption = "<b>Table 6</b>: Comparing the reach of current ACHD clinic locations to
                                  new ACHD clinic locations") %>%
  kable_classic_2(full_width = F, position = "left",
                  html_font = "Cambria",
                  font_size = 16) %>%
        column_spec(column = 2, width = "3cm")%>% 
        column_spec(column = 3, width = "3cm") %>% 
        column_spec(column = 4, width = "3cm") %>% 
        column_spec(column = 5, width = "3cm") %>% 
        column_spec(column = 6, width = "3cm") %>% 
        column_spec(column = 7, width = "3cm")
```
&nbsp;  
&nbsp;  
&nbsp; 
 
``` {r, echo = FALSE}
out = NULL

for (i in drive.values$area.report.list) 
{out = c(out, knit_expand('Area_Report.Rmd'))}
```

`r knit(text = out)`
  
  








