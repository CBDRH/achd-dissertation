---
title: "ACHD Report"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Allow dunplicate chunk names imported from the Child documents
options(knitr.duplicate.label = "allow")

library(tidyverse)
library(scales)
library(lubridate)
library(ggplot2)
library(ggpubr)
library(rgdal)
library(sp)
library(sf)
library(leaflet)
library(leaflet.extras)
library(tableHTML)
library(knitr)
library(kableExtra)
```

```{css, echo = FALSE}
.main-container {
    max-width: 90%;
}
```

``` {r, include = FALSE, echo = FALSE}
# the filtered achd data - not available in public version
# achd <- achd.filtered()

# area level achd data (note, before are changes are made by new clinic additions)
area.achd <- drive.area.achd()

# Diagnosis Frequency Data - This function is reliant on achd.filtered()
# dx.data <- dx.count()
```


This report was generated on `r Sys.Date()` from the Adult Congenital Heart Disease Clinic Planning Tool

## Patient Data

``` {r, include = FALSE, echo = FALSE}
# Some named list that can be used to pull the labels for each of the filters used on the patient data

# Sex filter
sex <- list('1' = 'Male',
            '2' = 'Female',
            '4' = 'Neither')

# bethesda severity filter
beth <- list('1' ="Simple",
             '2' ="Moderate",
             '3' ="Severe",
             '4' = "Unknown")

# Mortality Status filter
mort <- list('0' = 'Alive',
             '1' = 'Deceased')
```

The Patient Dataset had the following filters applied:  
  
* __Selected Genders:__ `r sex[input$sb.sex]`  
* __CHD Disease Severity:__ `r  beth[input$sb.bethesda]`
* __Age Range:__ `r input$sb.age[1]` yrs to `r input$sb.age[2]` yrs  
* __Time Period:__ `r format(as.Date(input$sb.dates[1]), "%d/%m/%Y")` to `r format(as.Date(input$sb.dates[2]), "%d/%m/%Y")`  
* __Years Since Last Clinic Visit:__ `r input$sb.last.clinic[1]` yrs to `r input$sb.last.clinic[2]` yrs  
* __Mortality Status:__ `r  mort[input$sb.mortality]` 

Note - the patient summary requires access to the patient level dataset and therefore is not available in the public version of the app.

## Area Data

``` {r, echo = FALSE, include = FALSE}
# Table Summarising the Area level data
area.summary <- data.frame(
  # Total Number of SA2 Areas
  no.areas = area.achd %>% summarise(
                      no.areas = n(), # All NSW
                      no.areas.syd = sum(GCC_NAME == "Greater Sydney", na.rm = TRUE), # Greater Sydney
                      no.areas.nsw = sum(GCC_NAME == "Rest of NSW", na.rm = TRUE), # Rest of NSW
                      no.areas.act = sum(GCC_NAME == "Australian Capital Territory", na.rm = TRUE), # ACT
                           ) %>% t(),
  # Number of Areas within 1 hour drive of ACHD Clinic
  n.area.hr = area.achd %>% filter(as.numeric(shortest_time, "hours") <= 1) %>%
                        summarise(
                        no.areas = n(), # All NSW
                        no.areas.syd = sum(GCC_NAME == "Greater Sydney", na.rm = TRUE), # Greater Sydney
                        no.areas.nsw = sum(GCC_NAME == "Rest of NSW", na.rm = TRUE), # Rest of NSW
                        no.areas.act = sum(GCC_NAME == "Australian Capital Territory", na.rm = TRUE), # ACT
                            ) %>% t(),
  # Average Driving to ACHD Clinic
  avg.drive = avg.drive <- area.achd %>% 
                    summarise(avg.drive = mean(as.numeric(shortest_time, 'hours'), na.rm = TRUE), # All NSW
                              avg.drive.syd = mean(as.numeric(shortest_time[.$GCC_NAME == "Greater Sydney"], 'hours'), 
                                                   na.rm = TRUE), # Greater Sydney
                              avg.drive.nsw = mean(as.numeric(shortest_time[.$GCC_NAME == "Rest of NSW"], 'hours'), 
                                                   na.rm = TRUE), # Rest of NSW
                              avg.drive.act = mean(as.numeric(shortest_time[.$GCC_NAME == "Australian Capital Territory"],
                                                              'hours'), # ACT
                                                   na.rm = TRUE),
                              ) %>% t()
                ) %>%
                mutate(p.area.hr = round(( n.area.hr / no.areas ) * 100, digits = 2),
                       avg.drive = round(avg.drive, digits = 2)) %>% #<hr areas as a percentage of total hours
                select(no.areas, n.area.hr, p.area.hr, avg.drive)

row.names(area.summary) <- c("All", "Greater Sydney", "Rest of NSW", "ACT")
```

Areas are the Statistical Area 2 (SA2) geographical boundaries, defined by the Australian Bureau of Statistics, below is a basic summary of the area level data before any new ACHD clinic locations have been selected:

``` {r, echo = FALSE}
# Display the Table Nicely
area.summary %>%
  kbl(align=rep('r', 4), # Centre the data
      # Add nice Column Names
      col.names = c("Areas (n)",
                  "Areas < 1hr (n)",
                  "Areas < 1hr (%)",
                  "Avg Drive Time (hr)"),
      # Table caption
      caption = "<b>Table 2</b>: Number of areas within one hour drive
                 to an ACHD clinic and the average driving time to ACHD clinics") %>%
  kable_classic_2(full_width = F, position = "left",
                  html_font = "Cambria",
                  font_size = 16)

```

&nbsp;  
&nbsp; 

``` {r, echo = FALSE, include = FALSE}
# Function to build the driving times for each area plots
area_st_plot <- function() {
          # All areas in NSW and ACHD
          all <- ggplot(area.achd, aes(x=as.numeric(shortest_time, "min"))) +
                            geom_histogram(fill = "light grey", bins = 50,
                                           color = "black", size = 0.25) +
                            theme_minimal() +
                            theme(axis.title.x=element_blank(),
                                  axis.title.y=element_blank()
                                  ) +
                            scale_x_continuous(limits = c(0,600)) +
                              ggtitle("All")
          # Greater Sydney Areas
          syd <- area.achd %>% filter(GCC_NAME == "Greater Sydney") %>%
                            ggplot(aes(x=as.numeric(shortest_time, "min"))) +
                              geom_histogram(fill = "light grey", bins = 50,
                                             color = "black", size = 0.25) +
                              theme_minimal() +
                              theme(axis.title.x=element_blank(),
                                    axis.title.y=element_blank()
                                    ) +
                              scale_x_continuous(limits = c(0,100)) +
                              ggtitle("Sydney")
          # Rest of NSW Areas
          nsw <- area.achd %>% filter(GCC_NAME == "Rest of NSW") %>%
                            ggplot(aes(x=as.numeric(shortest_time, "min"))) +
                              geom_histogram(fill = "light grey", bins = 50,
                                             color = "black", size = 0.25) +
                              theme_minimal() +
                              theme(axis.title.x=element_blank(),
                                    axis.title.y=element_blank()
                                    ) +
                              scale_x_continuous(limits = c(0,600)) +
                              ggtitle("Rest of NSW") 
          # ACT Areas
          act <- area.achd %>% filter(GCC_NAME == "Australian Capital Territory") %>%
                            ggplot(aes(x=as.numeric(shortest_time, "min"))) +
                              geom_histogram(fill = "light grey", bins = 50,
                                             color = "black", size = 0.25) +
                              theme_minimal() +
                              theme(axis.title.x=element_blank(),
                                    axis.title.y=element_blank()
                                    ) +
                              scale_x_continuous(limits = c(0,100)) +
                              ggtitle("ACT")
          # add graphs in a 2x2 layout
          layout <- ggarrange(all, syd, nsw, act, nrow = 2, ncol = 2)
          # annotate the layout
          annotate_figure(layout,
                          bottom = text_grob("Driving Time (mins)",
                                               size = 10),
                          left = text_grob("No.SA2 Areas", rot = 90,
                                             size = 10)
                          )

}
```

&nbsp;  
&nbsp;  

``` {r, echo = FALSE, warning = FALSE, message = FALSE}
# Print the area driving times map
area_st_plot()
```
&nbsp;  
__Figure 3:__ Distribution of the driving time from each SA2 area to the nearest ACHD clinic, for all of NSW,  
the Greater Sydney Region, the Rest of NSW and the Australia Capital Territory

### Distribution of the ACHD population
The map below shows the number of ACHD patients in each area. Driving times are calculated from the centre of each area.

&nbsp; 

``` {r, echo = FALSE, include = FALSE}
# Current map data is the data (polygons and area data) before new clinics are added. The data from the app will have been
# editted with new clinics so we will need to rebuild the data as it was before it was editted

# Filter the current map data by gcc region selected
current_map_data <- merge(sa2.polys, area.achd, by.x = 'NAME16', by.y = 'SA2_NAME')
# Add area demographics to the spatial information
current_map_data <- subset(current_map_data, current_map_data$GCC_NAME16 %in% input$drive.gcc)

# Set colour palette from current map data - driving overlay
current_pal_drive <- colorNumeric("YlOrRd", domain = as.numeric(current_map_data$shortest_time, 'hours'))

# Set colour palette from current map data - layout overlay
current_pal_loc <- colorNumeric("YlOrRd", domain = mask.achd(current_map_data$ACHD_count, 'int'))

# Labels for area mouse over
current_labels <- sprintf(
            "<strong>%s</strong><br/>
            %s ACHD patients<br/>
            Simple: %s | Moderate: %s | Severe: %s<br/>
            %.1f hr drive to nearest clinic<br/>",
            current_map_data$NAME16, 
            mask.achd(current_map_data$ACHD_count, 'str'),
            mask.achd(current_map_data$beth_1, 'str'), mask.achd(current_map_data$beth_2, 'str'), mask.achd(current_map_data$beth_3, 'str'),
            as.numeric(current_map_data$shortest_time, 'hours')
            ) %>% 
                lapply(htmltools::HTML)
```

``` {r, echo = FALSE, fig.width=13, fig.height=10, warning = FALSE, message = FALSE}
# Map showing the number of ACHD patients in each location
leaflet() %>%
            addTiles() %>%
            # Add Polygons
            addPolygons(
                    data = current_map_data,
                    layerId = ~CODE16,
                    fillColor = ~current_pal_loc(mask.achd(current_map_data$ACHD_count, 'int')),
                    weight = 1,
                    opacity = 1,
                    color = "white",
                    dashArray = "3",
                    fillOpacity = 0.7,
                    highlight = highlightOptions(
                        weight = 3,
                        color = "#666",
                        dashArray = "",
                        fillOpacity = 0.7,
                        bringToFront = TRUE),
                    label = current_labels,
                    labelOptions = labelOptions(
                        style = list("font-weight" = "normal", padding = "3px 8px"),
                        textsize = "15px",
                        direction = "auto")) %>%
                fitBounds(min(set_coords()$long),
                          min(set_coords()$lat),
                          max(set_coords()$long),
                          max(set_coords()$lat)) %>%
              # Add Legend
              addLegend(pal = current_pal_loc, 
                          values = current_map_data$ACHD_count, 
                          opacity = 0.7, 
                          title = "ACHD population",
                          position = "bottomright")

```


## Current ACHD Clinics in NSW

There are currently 6 Clinic locatios for Adult Congenital Heart Disease Services in NSW. Please note that not all clinic locations are available in the Hospital Travel Times dataset, in these cases, the closest available hospital has been used instead. The table below outlines the clinic matches and the distance between them.

``` {r, echo = FALSE, include = FALSE}
# Table to show how the current outreach clinic locations have been matched with the clinics in the HTT datasets
clinic.matches <- data.frame(
  achd.clinic = c("Orange Central West Cardiology",
               "Nowra Shoalhaven Cardiology",
               "Canberra More Than Medicine",
               "Port Macquarie Port Macquarie Cardiology",
               "Royal Prince Alfred Hospital",
               "Westmead Private Hospital"
              ),
  htt.clinic = c("Orange Day Surgery Centre",
                 "Shoalhaven Hospital",
                 "Canberra Imaging Group Angiography/Interventional Suite",
                 "Port Macquarie Hospital",
                 "Royal Prince Alfred Hospital",
                 "Westmead Private Hospital"
                ),
  distance = c("1.1", "1.2", "8", "0.5", "0", "0")
)
```


``` {r, echo = FALSE}
# Display the table nicely
clinic.matches %>%
  kbl(align=c('l','l','r'), # Centre the data
      # Add nice column name
      col.names = c("Current ACHD Clinics",
                  "Closest HTT Clinics",
                  "Distance between (kms)"),
      # Caption for the table
      caption = "<b>Table 3</b>: Matching current ACHD clinics to Hospital 
                 Travel Time (HTT) Clincis") %>%
  kable_classic_2(full_width = F, position = "left",
                  html_font = "Cambria",
                  font_size = 16)
```

&nbsp;  

``` {r, echo = FALSE}
# Table displaying info for current clinics
drive.values$current_clinic_table %>%
  # Add Total Column
  bind_rows(summarise_all(., ~if(is.numeric(.)) sum(.) else "Total")) %>%
  #Display the table nicely
            kbl(align=c('l','r','r'), # Centre the data
      # Nice Column Names
      col.names = c("Current ACHD Clinics",
                  "Patient within 1hr (n)",
                  "Lost to F/up within 1hr (n)"),
      # Table Caption
      caption = "<b>Table 4</b>: Number of patients captured by each hospital") %>%
  kable_classic_2(full_width = F, position = "left",
                  html_font = "Cambria",
                  font_size = 16) 
```

&nbsp;  

### Average Driving time to ACHD Clinics  
The map below details the driving time from each SA2 area in NSW to the nearest ACHD Clinic. Driving times are calculated from the centre of each area.

&nbsp;  

``` {r, echo = FALSE, fig.width=13, fig.height=10}
# Remove NAs from legend
leg_data <- current_map_data@data %>% filter(!is.na(shortest_time))

# Map showing the driving times to clinics - current clinics only
leaflet() %>%
            addTiles() %>%
            addAwesomeMarkers(
                data = htt.details %>% filter(Hospital_ID %in% achd_ids),
                lng = ~Longitude,
                lat = ~Latitude,
                label = ~Hospital.name,
                icon = ~HospitalIcons["Current"]) %>%
            # Add Polygons
            addPolygons(
                data = drive.polys(),
                layerId = ~CODE16,
                fillColor = ~current_pal_drive(as.numeric(current_map_data$shortest_time, 'hours')),
                weight = 1,
                opacity = 1,
                color = "white",
                dashArray = "3",
                fillOpacity = 0.7,
                highlight = highlightOptions(
                    weight = 3,
                    color = "#666",
                    dashArray = "",
                    fillOpacity = 0.7,
                    bringToFront = TRUE),
                label = current_labels,
                labelOptions = labelOptions(
                    style = list("font-weight" = "normal", padding = "3px 8px"),
                    textsize = "15px",
                    direction = "auto")) %>%
                fitBounds(min(set_coords()$long),
                          min(set_coords()$lat),
                          max(set_coords()$long),
                          max(set_coords()$lat)) %>%
                # Add Legend
                addLegend(pal = current_pal_drive, 
                          values = as.numeric(leg_data$shortest_time, 'hours'), 
                          opacity = 0.7, 
                          title = "Driving time (hrs)",
                          position = "bottomright",
                          layerId = 'drive.legend')

```

&nbsp;  

``` {r, echo = FALSE, results = 'asis'}
#If there use has selected new clincis, add the New Clinic Report template to the report
if ( length(drive.values$add_clinic_table$Hospital) != 0 ) {
    
  cat(knit(text = knit_expand("New_Clinic_Report.Rmd"),
       quiet = TRUE))
  
    }
```


 
``` {r, echo = FALSE, results = 'asis'}
# If the user has added areas to the report
if ( !is.null(drive.values$area.report.list) ) {
     out = NULL
     
     # apply the area report template for each area
        src <- lapply(drive.values$area.report.list,
                      function(i) knit_expand('Area_Report.Rmd'))
        # render the area reports
        cat(knit(text = src,
                 quiet = TRUE))
        
  }
```