---
title: "ACHD Clinic Planning Tool: Automated Report"
output: 
  pdf_document:
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{float}
  - \let\origfigure\figure
  - \let\endorigfigure\endfigure
  - \renewenvironment{figure}[1][2] {
      \expandafter\origfigure\expandafter[H]
    } {
      \endorigfigure
    }
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tinytex)
options(tinytex.verbose = TRUE)

# Allow dunplicate chunk names imported from the Child documents
options(knitr.duplicate.label = "allow")

library(tidyverse)
library(scales)
library(lubridate)
library(ggplot2)
library(ggpubr)
library(rgdal)
library(sp)
library(sf)
library(leaflet)
library(leaflet.extras)
library(tableHTML)
library(knitr)
library(kableExtra)
library(mapview)
```

```{r, include = FALSE, echo = FALSE}
#function to mask ACHD area count data
mask.achd <- function (data, type) {
  if (type == "int") {
    ifelse(data > 5, data, 5) 
  } else if (type == "str") {
    ifelse(data > 5, data, "<5")
  } else { 
    print("invalid string") 
  }  
}

# the filtered achd data
achd <- achd.filtered()

# area level achd data (note, before are changes are made by new clinic additions)
area.achd <- drive.area.achd()

# Diagnosis Frequency Data
dx.data <- dx.count()
```

This report was generated on `r Sys.Date()` from the Adult Congenital Heart Disease Clinic Planning Tool

## Patient Data

```{r, include = FALSE, echo = FALSE}
# Some named list that can be used to pull the labels for each of the filters used on the patient data

# Sex filter
sex <- list('1' = 'Male',
            '2' = 'Female',
            '4' = 'Neither')

# bethesda severity filter
beth <- list('1' ="Simple",
             '2' ="Moderate",
             '3' ="Severe",
             '4' = "Unknown")

# Mortality Status filter
mort <- list('0' = 'Alive',
             '1' = 'Deceased')
```

The Patient Dataset had the following filters applied:

-   **Selected Genders:** `r sex[input$sb.sex]`
-   **CHD Disease Severity:** `r  beth[input$sb.bethesda]`
-   **Age Range:** `r input$sb.age[1]` yrs to `r input$sb.age[2]` yrs
-   **Time Period:** `r format(as.Date(input$sb.dates[1]), "%d/%m/%Y")` to `r format(as.Date(input$sb.dates[2]), "%d/%m/%Y")`
-   **Years Since Last Clinic Visit:** `r input$sb.last.clinic[1]` yrs to `r input$sb.last.clinic[2]` yrs
-   **Mortality Status:** `r  mort[input$sb.mortality]`

```{r, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Table Summarising the Patient data
pt.summary <- data.frame(
                        # Total number of patients
                        no.patient = achd %>% summarise(
                                                    achd.no = n(), # All Patients
                                                    simple.no = sum(bethesda_code == 1), # Simple CHD
                                                    moderate.no = sum(bethesda_code == 2), # Moderate CHD
                                                    complex.no = sum(bethesda_code == 3) # Complex CHD
                                                  ) %>% t(),
                        # Number of Patients Lost to Follow up
                        ltf.patient = achd %>% filter(ltf_3 == 1) %>%
                                                summarise(
                                                    achd.no = n(), # All Patients
                                                    simple.no = sum(bethesda_code == 1), # Simple CHD
                                                    moderate.no = sum(bethesda_code == 2), # Moderate CHD
                                                    complex.no = sum(bethesda_code == 3) # Complex CHD
                                                  )  %>% t(),
                        # Number of Patients within 1 hour drive
                        hr.patient = area.achd %>% filter(as.numeric(shortest_time, "hours") <= 1) %>%
                                                    summarise(
                                                      hr.no = sum(ACHD_count), # All Patients
                                                      hr.simple = sum(beth_1), # Simple CHD
                                                      hr.moderate = sum(beth_2), # Moderate CHD
                                                      hr.complex = sum(beth_3) # Complex CHD
                                                    ) %>% t()
                          ) %>% 
                            mutate(ltf.percent = round( ( ltf.patient / no.patient ) * 100, digits = 2 ), #LTF patients as a percentage of all patients
                                   hr.percent = round( ( hr.patient / no.patient ) * 100, digits = 2 )) %>% #<hr patients as a perc of all patients
                            select(no.patient, ltf.percent, hr.percent)

row.names(pt.summary) <- c("All", "Simple CHD", "Moderate CHD", "Complex CHD")
```

```{r, echo = FALSE}
# Display the Table Nicely
pt.summary %>%
  kbl(booktabs = T,
      align=rep('r', 3), # right align the data
      # Add nice Column Names
      col.names = c("Patients (n)",
                    "Lost to F/up (%)",
                    "Pts < 1 hr drive (%)"),
      # Table caption
      caption = "\\textbf{Number of patients, lost to follow up rates and driving time to
      clinics;by disease severity}") %>%
  kable_styling(full_width = F,
                latex_options = "striped",
                position = "left"
                )  %>%
  column_spec(1, width = "8cm")
```

```{r, include = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Plots for patient level demographics
global_font <- 16

# Age Histogram
age_plot <- ggplot(achd, aes(x=as.numeric(age, "years"))) +
                  geom_histogram(fill = "light grey", color = "black") +
                  labs(y = "Number of Patients", 
                       x = "Age (yrs)") +
                  theme(axis.title.x=element_blank()) +
                  theme_minimal(base_size = global_font)

# Sex Bar Plot
sex_plot <- achd %>% filter(!is.na(sex)) %>%
                ggplot(aes(x=sex)) +
                    geom_bar(fill = "light grey", color = "black") +
                    scale_x_discrete(name = "",
                                     labels=str_wrap(c("1" = "Male", "2" = "Female",
                                              "4" =  "Neither Female or Male"),
                                              width = 10)) +
                    labs(y = "Number of Patients") +
                    theme(axis.title.x=element_blank()) +
                    theme_minimal(base_size = global_font)

# Number of dx per patients
ndx_plot <- ggplot(achd, aes(x=as.integer(no_dx)) ) +
                    geom_bar(fill = "light grey", color = "black") +
                    scale_x_continuous() +
                    labs(x = "Number of Diagnoses", 
                         y = "Number of Patients") +
                    theme() +
                    theme_minimal(base_size = global_font) 

# Number of Clinic visits per patient
nclinic_plot <- ggplot(achd, aes(x=no_clinics_2000)) +
                        geom_bar(fill = "light grey", color = "black") +
                        scale_x_continuous() +
                        labs(x = "Number of Clinic Visits", 
                             y = "Number of Patients") +
                        theme() +
                        theme_minimal(base_size = global_font) 

# Time since last visit histogram
ltf_plot <- ggplot(achd, aes(x=as.numeric(gap_2000, "years"))) +
                        geom_histogram(fill = "light grey", color = "black") +
                        labs(y = "Number of Patients", 
                             x = "Time since last clinic visit (yrs)") +
                        theme(axis.title.x=element_blank()) +
                        theme_minimal(base_size = global_font)

# Frequency of each dx
dx_plot <- dx.data %>% filter(dx_count > 0) %>% slice_max(dx_count, n = 20) %>%
                          ggplot(aes(x = reorder(dx_label, dx_count), y=dx_count)) + 
                              geom_bar(stat="identity", fill = "light grey", color = "black", size = 0.25) +
                              theme(axis.text.x = element_text(angle = 90)) +
                              labs(title = "Frequecy of each diagnosis", 
                                   y = "count",
                                   x = "") +
                              coord_flip() +
                              theme_minimal(base_size = 20)
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=10, fig.cap = "Patient level demographics; **A** distribution of patient age, **B** time since patients last clinic visit, **C** distribution of patient sex, **D** the number of diagnoses per patient and **E** number of clinic visits per patient."}
# Figure 1 - Patient level demograohics
fig_1 <-ggarrange(
              ggarrange(age_plot, ltf_plot, labels = c("A","B"), nrow = 1),
              ggarrange(sex_plot, ndx_plot, nclinic_plot, labels = c("C", "D", "E"), nrow = 1),
              nrow = 2
              )

fig_1
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=20, fig.cap="The top twenty most frequently occuring congenital heart disease diagnoses."}
# Figure 2 - Frequency of each Diagnosis
dx_plot
```

## Area Data

Areas are the Statistical Area 2 (SA2) geographical boundaries, defined by the Australian Bureau of Statistics, below is a basic summary of the area level data before any new ACHD clinic locations have been selected:

```{r, echo = FALSE, include = FALSE}
# Table Summarising the Area level data
area.summary <- data.frame(
  # Total Number of SA2 Areas
  no.areas = area.achd %>% summarise(
                      no.areas = n(), # All NSW
                      no.areas.syd = sum(GCC_NAME == "Greater Sydney", na.rm = TRUE), # Greater Sydney
                      no.areas.nsw = sum(GCC_NAME == "Rest of NSW", na.rm = TRUE), # Rest of NSW
                      no.areas.act = sum(GCC_NAME == "Australian Capital Territory", na.rm = TRUE), # ACT
                           ) %>% t(),
  # Number of Areas within 1 hour drive of ACHD Clinic
  n.area.hr = area.achd %>% filter(as.numeric(shortest_time, "hours") <= 1) %>%
                        summarise(
                        no.areas = n(), # All NSW
                        no.areas.syd = sum(GCC_NAME == "Greater Sydney", na.rm = TRUE), # Greater Sydney
                        no.areas.nsw = sum(GCC_NAME == "Rest of NSW", na.rm = TRUE), # Rest of NSW
                        no.areas.act = sum(GCC_NAME == "Australian Capital Territory", na.rm = TRUE), # ACT
                            ) %>% t(),
  # Average Driving to ACHD Clinic
  avg.drive = avg.drive <- area.achd %>% 
                    summarise(avg.drive = mean(as.numeric(shortest_time, 'hours'), na.rm = TRUE), # All NSW
                              avg.drive.syd = mean(as.numeric(shortest_time[.$GCC_NAME == "Greater Sydney"], 'hours'), 
                                                   na.rm = TRUE), # Greater Sydney
                              avg.drive.nsw = mean(as.numeric(shortest_time[.$GCC_NAME == "Rest of NSW"], 'hours'), 
                                                   na.rm = TRUE), # Rest of NSW
                              avg.drive.act = mean(as.numeric(shortest_time[.$GCC_NAME == "Australian Capital Territory"],
                                                              'hours'), # ACT
                                                   na.rm = TRUE),
                              ) %>% t()
                ) %>%
                mutate(p.area.hr = round( ( n.area.hr / no.areas ) * 100, digits = 2),
                       avg.drive = round(avg.drive, digits = 2)) %>% #<hr areas as a percentage of total hours
                select(no.areas, n.area.hr, p.area.hr, avg.drive)

row.names(area.summary) <- c("All", "Greater Sydney", "Rest of NSW", "ACT")
```

```{r, echo = FALSE}
# Display the Table Nicely
area.summary %>%
  kbl(booktabs = T,
      align=rep('r', 4), # Centre the data
      # Add nice Column Names
      col.names = c("Areas (n)",
                  "Areas < 1hr (n)",
                  "Areas < 1hr (%)",
                  "Avg Drive Time (hr)"),
      # Table caption
      caption = "\\textbf{Number of areas within one hour drive
                 to an ACHD clinic and the average driving time to ACHD clinics}") %>%
  kable_styling(full_width = F,
                latex_options = c("striped", "hold_position"),
                position = "left"
                )

```


```{r, echo = FALSE, include = FALSE}
# Function to build the driving times for each area plots
area_st_plot <- function() {
          # All areas in NSW and ACHD
          all <- ggplot(area.achd, aes(x=as.numeric(shortest_time, "min"))) +
                            geom_histogram(fill = "light grey", bins = 50,
                                           color = "black", size = 0.25) +
                            theme_minimal() +
                            theme(axis.title.x=element_blank(),
                                  axis.title.y=element_blank()
                                  ) +
                            scale_x_continuous(limits = c(0,600)) +
                              ggtitle("All")
          # Greater Sydney Areas
          syd <- area.achd %>% filter(GCC_NAME == "Greater Sydney") %>%
                            ggplot(aes(x=as.numeric(shortest_time, "min"))) +
                              geom_histogram(fill = "light grey", bins = 50,
                                             color = "black", size = 0.25) +
                              theme_minimal() +
                              theme(axis.title.x=element_blank(),
                                    axis.title.y=element_blank()
                                    ) +
                              scale_x_continuous(limits = c(0,100)) +
                              ggtitle("Sydney")
          # Rest of NSW Areas
          nsw <- area.achd %>% filter(GCC_NAME == "Rest of NSW") %>%
                            ggplot(aes(x=as.numeric(shortest_time, "min"))) +
                              geom_histogram(fill = "light grey", bins = 50,
                                             color = "black", size = 0.25) +
                              theme_minimal() +
                              theme(axis.title.x=element_blank(),
                                    axis.title.y=element_blank()
                                    ) +
                              scale_x_continuous(limits = c(0,600)) +
                              ggtitle("Rest of NSW") 
          # ACT Areas
          act <- area.achd %>% filter(GCC_NAME == "Australian Capital Territory") %>%
                            ggplot(aes(x=as.numeric(shortest_time, "min"))) +
                              geom_histogram(fill = "light grey", bins = 50,
                                             color = "black", size = 0.25) +
                              theme_minimal() +
                              theme(axis.title.x=element_blank(),
                                    axis.title.y=element_blank()
                                    ) +
                              scale_x_continuous(limits = c(0,100)) +
                              ggtitle("ACT")
          # add graphs in a 2x2 layout
          layout <- ggarrange(all, syd, nsw, act, nrow = 2, ncol = 2)
          # annotate the layout
          annotate_figure(layout,
                          bottom = text_grob("Driving Time (mins)",
                                               size = 10),
                          left = text_grob("No.SA2 Areas", rot = 90,
                                             size = 10)
                          )

}
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap="Distribution of the driving time from each SA2 area to the nearest ACHD clinic, for all of NSW,the Greater Sydney Region, the Rest of NSW and the Australia Capital Territory."}
# Print the area driving times map
area_st_plot()
```

\newpage

## Current ACHD Clinics in NSW

There are currently 6 Clinic locations for Adult Congenital Heart Disease Services in NSW. Please note that not all clinic locations are available in the Hospital Travel Times data set, in these cases, the closest available hospital has been used instead. The table below outlines the clinic matches and the distance between them.

``` {r, echo = FALSE, include = FALSE}
# Table to show how the current outreach clinic locations have been matched with the clinics in the HTT datasets
clinic.matches <- data.frame(
  achd.clinic =c("Orange Central West Cardiology",
               "Nowra Shoalhaven Cardiology",
               "Canberra More Than Medicine",
               "Port Macquarie Port Macquarie Cardiology",
               "Royal Prince Alfred Hospital",
               "Westmead Private Hospital"
              ),
  htt.clinic = c("Orange Day Surgery Centre",
                 "Shoalhaven Hospital",
                 "Canberra Imaging Group Angiography/Interventional Suite",
                 "Port Macquarie Hospital",
                 "Royal Prince Alfred Hospital",
                 "Westmead Private Hospital"
                ),
  distance = c("1.1", "1.2", "8", "0.5", "0", "0")
)
```

``` {r, echo = FALSE}
# Display the table nicely
clinic.matches %>%
  kbl(booktabs = T,
      align=c('l','l','r'), # Centre the data
      # Add nice column name
      col.names = c("Current ACHD Clinics",
                  "Closest HTT Clinics",
                  "Distance between (kms)"),
      # Caption for the table
      caption = "\\textbf{Matching current ACHD clinics to Hospital 
                 Travel Time (HTT) Clincis}") %>%
  kable_styling(full_width = F,
                latex_options = c("striped", "hold_position"),
                position = "left"
                ) %>% 
  column_spec(c(1,2), width = "20em") %>%
  column_spec(3, width = "5em")
```

``` {r, echo = FALSE}
# Table displaying info for current clinics
drive.values$current_clinic_table %>%
  # Add Total Column
  bind_rows(summarise_all(., ~if(is.numeric(.)) sum(.) else "Total")) %>%
  #Display the table nicely
  kbl(booktabs = T,
      align=c('l','r','r'), # Centre the data
      # Nice Column Names
      col.names = c("Current ACHD Clinics",
                  "Patient within 1hr (n)",
                  "Lost to F/up within 1hr (n)"),
      # Table Caption
      caption = "\\textbf{Number of patients captured by each hospital}") %>%
  kable_styling(full_width = F,
                latex_options = c("striped", "hold_position"),
                position = "left"
                )%>% 
  column_spec(c(2,3), width = "7.5em") %>%
  column_spec(1, width = "30em")
```

``` {r, echo = FALSE, results = 'asis'}
#If there user has selected new clincs, add the New Clinic Report template to the report
if ( length(drive.values$add_clinic_table$Hospital) != 0 ) {
    
  cat(knit(text = knit_expand("New_Clinic_Report_pdf.Rmd"),
       quiet = TRUE))
  
    }
```

``` {r, echo = FALSE, results = 'asis'}
# If the user has added areas to the report
if ( !is.null(drive.values$area.report.list) ) {
     out = NULL
     
     # apply the area report template for each area
        src <- lapply(drive.values$area.report.list,
                      function(i) knit_expand('Area_Report_pdf.Rmd'))
        # render the area reports
        cat(knit(text = src,
                 quiet = TRUE))
        
  }
```
